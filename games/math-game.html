<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Octo-Math!</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Lilita+One&family=Nunito:wght@600;700;800;900&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg-deep: #1a0a2e;
    --bg-mid: #2d1b69;
    --purple-light: #b56bff;
    --purple-mid: #8b3fd4;
    --purple-dark: #5c1f9e;
    --green-correct: #4cdb6a;
    --green-glow: rgba(76,219,106,0.3);
    --red-wrong: #ff5c6a;
    --red-glow: rgba(255,92,106,0.3);
    --yellow: #ffe156;
    --cyan: #56d4ff;
    --pink: #ff6b9d;
    --card-bg: rgba(255,255,255,0.06);
    --card-border: rgba(255,255,255,0.1);
  }

  html, body { height: 100%; }

  body {
    font-family: 'Nunito', sans-serif;
    background: linear-gradient(160deg, var(--bg-deep) 0%, var(--bg-mid) 50%, #1e0e3e 100%);
    color: #fff;
    min-height: 100dvh;
    overflow-x: hidden;
    display: flex;
    flex-direction: column;
    -webkit-tap-highlight-color: transparent;
  }

  /* Top bar */
  .top-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.8rem 1rem;
    background: rgba(0,0,0,0.25);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    position: sticky;
    top: 0;
    z-index: 50;
  }
  .back-btn {
    display: flex; align-items: center; gap: 0.3rem;
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.12);
    color: #ccc;
    font-family: 'Nunito', sans-serif;
    font-weight: 700;
    font-size: 0.85rem;
    padding: 0.45rem 0.9rem;
    border-radius: 2rem;
    cursor: pointer;
    text-decoration: none;
    transition: background 0.2s;
  }
  .back-btn:hover { background: rgba(255,255,255,0.14); color: #fff; }
  .top-title {
    font-family: 'Lilita One', cursive;
    font-size: 1.1rem;
    color: var(--purple-light);
  }
  .round-badge {
    background: rgba(181,107,255,0.18);
    border: 1px solid rgba(181,107,255,0.3);
    color: var(--purple-light);
    font-family: 'Nunito', sans-serif;
    font-weight: 800;
    font-size: 0.78rem;
    padding: 0.35rem 0.7rem;
    border-radius: 2rem;
    cursor: pointer;
    transition: background 0.2s;
  }
  .round-badge:hover, .round-badge:active {
    background: rgba(181,107,255,0.32);
  }

  .round-picker-wrap {
    position: relative;
  }
  .round-picker {
    position: absolute;
    top: calc(100% + 0.4rem);
    right: 0;
    background: rgba(26, 10, 46, 0.97);
    border: 1px solid rgba(181,107,255,0.3);
    border-radius: 0.8rem;
    padding: 0.3rem;
    display: none;
    z-index: 60;
    min-width: 170px;
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    box-shadow: 0 8px 30px rgba(0,0,0,0.5);
    max-height: 280px;
    overflow-y: auto;
  }
  .round-picker.visible {
    display: block;
  }
  .round-picker-option {
    display: block;
    width: 100%;
    padding: 0.5rem 0.75rem;
    font-family: 'Nunito', sans-serif;
    font-size: 0.78rem;
    font-weight: 700;
    color: rgba(255,255,255,0.7);
    background: none;
    border: none;
    border-radius: 0.5rem;
    cursor: pointer;
    text-align: left;
    transition: background 0.15s;
  }
  .round-picker-option:hover {
    background: rgba(181,107,255,0.2);
    color: #fff;
  }
  .round-picker-option.active {
    background: rgba(181,107,255,0.25);
    color: var(--purple-light);
  }

  /* Main area */
  .main {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    max-width: 500px;
    width: 100%;
    margin: 0 auto;
    padding: 0.5rem 1rem 1rem;
  }

  /* Progress bar */
  .progress-wrap {
    width: 100%;
    margin-bottom: 0.5rem;
  }
  .progress-label {
    display: flex;
    justify-content: space-between;
    font-size: 0.75rem;
    font-weight: 700;
    color: rgba(255,255,255,0.5);
    margin-bottom: 0.35rem;
  }
  .progress-track {
    width: 100%;
    height: 10px;
    background: rgba(255,255,255,0.08);
    border-radius: 99px;
    overflow: hidden;
  }
  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--purple-mid), var(--purple-light));
    border-radius: 99px;
    transition: width 0.5s ease;
    width: 0%;
  }

  /* Header octopus */
  .octo-header {
    position: relative;
    width: 44px;
    height: 44px;
    flex-shrink: 0;
  }
  .octo-header .octopus-svg {
    width: 100%;
    height: 100%;
    transition: transform 0.3s;
  }
  .octo-header.celebrate .octopus-svg {
    animation: octoWiggle 0.5s ease-in-out;
  }
  .octo-header.sad .octopus-svg {
    animation: octoSad 0.6s ease-in-out;
  }

  @keyframes octoWiggle {
    0% { transform: rotate(0deg) scale(1); }
    20% { transform: rotate(-8deg) scale(1.1); }
    40% { transform: rotate(8deg) scale(1.1); }
    60% { transform: rotate(-5deg) scale(1.05); }
    80% { transform: rotate(5deg) scale(1.05); }
    100% { transform: rotate(0deg) scale(1); }
  }
  @keyframes octoSad {
    0% { transform: translateY(0); }
    30% { transform: translateY(6px); }
    100% { transform: translateY(0); }
  }

  /* Speech bubble */
  .speech-bubble {
    position: absolute;
    top: 110%;
    left: 50%;
    background: #fff;
    color: #333;
    font-weight: 800;
    font-size: 0.72rem;
    padding: 0.3rem 0.6rem;
    border-radius: 0.8rem;
    box-shadow: 0 3px 12px rgba(0,0,0,0.2);
    opacity: 0;
    transform: translateX(-50%) scale(0.8);
    transition: all 0.3s;
    pointer-events: none;
    white-space: nowrap;
    z-index: 55;
  }
  .speech-bubble.visible {
    opacity: 1;
    transform: translateX(-50%) scale(1);
  }
  .speech-bubble::after {
    content: '';
    position: absolute;
    top: -5px;
    left: 50%;
    margin-left: -5px;
    width: 10px; height: 10px;
    background: #fff;
    transform: rotate(45deg);
    border-radius: 2px;
  }

  /* Question card */
  .question-card {
    width: 100%;
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 1.4rem;
    padding: 1rem 1.2rem;
    text-align: center;
    margin-bottom: 0.6rem;
    min-height: 70px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: border-color 0.3s, box-shadow 0.3s;
  }
  .question-card.correct {
    border-color: var(--green-correct);
    box-shadow: 0 0 25px var(--green-glow);
  }
  .question-card.wrong {
    border-color: var(--red-wrong);
    box-shadow: 0 0 25px var(--red-glow);
  }

  .level-tag {
    font-size: 0.7rem;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--purple-light);
    margin-bottom: 0.5rem;
  }

  .question-text {
    font-family: 'Lilita One', cursive;
    font-size: clamp(2rem, 8vw, 3rem);
    letter-spacing: 2px;
    color: #fff;
  }

  .feedback-text {
    margin-top: 0.6rem;
    font-weight: 800;
    font-size: 1rem;
    min-height: 1.4rem;
  }
  .feedback-text.correct-fb { color: var(--green-correct); }
  .feedback-text.wrong-fb { color: var(--red-wrong); }

  /* Answer input area */
  .answer-area {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.4rem;
  }

  .answer-display {
    font-family: 'Lilita One', cursive;
    font-size: 2.2rem;
    color: var(--yellow);
    min-height: 2.6rem;
    display: flex;
    align-items: center;
    justify-content: center;
    letter-spacing: 3px;
  }
  .answer-display .cursor {
    display: inline-block;
    width: 2px;
    height: 2.2rem;
    background: var(--yellow);
    margin-left: 2px;
    animation: blink 1s step-end infinite;
  }
  @keyframes blink { 50% { opacity: 0; } }

  /* Numpad */
  .numpad {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.45rem;
    width: 100%;
    max-width: 320px;
  }

  .num-btn {
    font-family: 'Nunito', sans-serif;
    font-weight: 900;
    font-size: 1.5rem;
    color: #fff;
    background: rgba(255,255,255,0.08);
    border: 1.5px solid rgba(255,255,255,0.12);
    border-radius: 1rem;
    padding: 0.7rem;
    cursor: pointer;
    transition: transform 0.1s, background 0.15s;
    user-select: none;
    -webkit-user-select: none;
  }
  .num-btn:active {
    transform: scale(0.93);
    background: rgba(255,255,255,0.16);
  }
  .num-btn.zero { grid-column: 1 / 2; }
  .num-btn.backspace {
    background: rgba(255,92,106,0.12);
    border-color: rgba(255,92,106,0.25);
    font-size: 1.3rem;
  }
  .num-btn.submit-btn {
    background: linear-gradient(135deg, var(--purple-mid), var(--purple-light));
    border-color: transparent;
    font-size: 1.1rem;
    letter-spacing: 1px;
  }
  .num-btn.submit-btn:active {
    transform: scale(0.93);
    filter: brightness(1.15);
  }
  .num-btn.next-btn {
    grid-column: 1 / -1;
    background: linear-gradient(135deg, #2d8f44, var(--green-correct));
    border-color: transparent;
    font-size: 1.1rem;
    padding: 0.7rem;
    letter-spacing: 1px;
  }
  .num-btn.next-btn:active { filter: brightness(1.15); }

  /* Score display */
  .score-bar {
    display: flex;
    justify-content: center;
    gap: 0.25rem;
    margin-bottom: 0.5rem;
    flex-wrap: wrap;
  }
  .score-dot {
    width: 18px; height: 18px;
    border-radius: 50%;
    background: rgba(255,255,255,0.1);
    border: 2px solid rgba(255,255,255,0.15);
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.6rem;
  }
  .score-dot.correct-dot {
    background: var(--green-correct);
    border-color: var(--green-correct);
    box-shadow: 0 0 8px var(--green-glow);
  }
  .score-dot.wrong-dot {
    background: var(--red-wrong);
    border-color: var(--red-wrong);
    box-shadow: 0 0 8px var(--red-glow);
  }
  .score-dot.current-dot {
    border-color: var(--yellow);
    box-shadow: 0 0 8px rgba(255,225,86,0.4);
  }

  /* Round summary overlay */
  .overlay {
    position: fixed;
    inset: 0;
    background: rgba(10,5,20,0.92);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1.5rem;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.35s;
  }
  .overlay.visible { opacity: 1; pointer-events: auto; }

  .summary-card {
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 1.6rem;
    padding: 2rem 1.5rem;
    text-align: center;
    max-width: 380px;
    width: 100%;
    transform: scale(0.9);
    transition: transform 0.35s;
  }
  .overlay.visible .summary-card { transform: scale(1); }

  .summary-emoji { font-size: 3rem; margin-bottom: 0.5rem; }
  .summary-title {
    font-family: 'Lilita One', cursive;
    font-size: 1.8rem;
    margin-bottom: 0.3rem;
  }
  .summary-score {
    font-size: 3rem;
    font-weight: 900;
    margin: 0.5rem 0;
  }
  .summary-score .of { font-size: 1.2rem; color: var(--purple-light); }
  .summary-msg { color: rgba(255,255,255,0.6); font-weight: 700; font-size: 0.9rem; margin-bottom: 1.2rem; }

  .summary-btns {
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
  }
  .summary-btn {
    font-family: 'Nunito', sans-serif;
    font-weight: 800;
    font-size: 1rem;
    padding: 0.9rem;
    border: none;
    border-radius: 1rem;
    cursor: pointer;
    transition: transform 0.15s, filter 0.15s;
  }
  .summary-btn:active { transform: scale(0.96); }
  .btn-primary {
    background: linear-gradient(135deg, var(--purple-mid), var(--purple-light));
    color: #fff;
  }
  .btn-secondary {
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.12);
    color: #ccc;
  }

  /* Confetti canvas */
  #confetti {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 200;
  }

  /* Start screen */
  .start-screen {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 2rem;
    gap: 1rem;
  }
  .start-screen h2 {
    font-family: 'Lilita One', cursive;
    font-size: clamp(2rem, 7vw, 2.8rem);
    background: linear-gradient(135deg, var(--purple-light), var(--pink));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .start-screen p { color: rgba(255,255,255,0.55); font-weight: 700; max-width: 300px; }
  .start-btn {
    font-family: 'Nunito', sans-serif;
    font-weight: 800;
    font-size: 1.2rem;
    padding: 1rem 2.5rem;
    background: linear-gradient(135deg, var(--purple-mid), var(--purple-light));
    color: #fff;
    border: none;
    border-radius: 1.2rem;
    cursor: pointer;
    margin-top: 0.5rem;
    transition: transform 0.15s;
  }
  .start-btn:active { transform: scale(0.95); }

  /* Particles */
  .particles {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 0;
    overflow: hidden;
  }
  .particle {
    position: absolute;
    border-radius: 50%;
    opacity: 0.15;
    animation: floatUp linear infinite;
  }
  @keyframes floatUp {
    0% { transform: translateY(100vh) scale(0); opacity: 0; }
    10% { opacity: 0.15; }
    90% { opacity: 0.15; }
    100% { transform: translateY(-10vh) scale(1); opacity: 0; }
  }
</style>
</head>
<body>

<div class="particles" id="particles"></div>
<canvas id="confetti"></canvas>

<!-- Top bar -->
<div class="top-bar" id="topBar" style="display:none;">
  <a href="../index.html" class="back-btn">‚Äπ Home</a>
  <div class="octo-header" id="octoArea">
    <div class="speech-bubble" id="speechBubble"></div>
    <svg class="octopus-svg" viewBox="0 0 200 200" id="octoSvg">
      <ellipse cx="100" cy="85" rx="55" ry="50" fill="#9b59b6"/>
      <ellipse cx="100" cy="85" rx="55" ry="50" fill="url(#bodyGrad2)"/>
      <ellipse cx="88" cy="72" rx="18" ry="14" fill="rgba(255,255,255,0.12)"/>
      <g id="octoEyes">
        <ellipse cx="82" cy="82" rx="12" ry="13" fill="#fff"/>
        <ellipse cx="118" cy="82" rx="12" ry="13" fill="#fff"/>
        <circle cx="84" cy="83" r="6" fill="#2c1654" class="pupil-l"/>
        <circle cx="120" cy="83" r="6" fill="#2c1654" class="pupil-r"/>
        <circle cx="86" cy="81" r="2.2" fill="#fff"/>
        <circle cx="122" cy="81" r="2.2" fill="#fff"/>
      </g>
      <g id="octoMouth">
        <path d="M90 100 Q100 110 110 100" stroke="#2c1654" stroke-width="2.5" fill="none" stroke-linecap="round"/>
      </g>
      <g id="octoTentacles">
        <path d="M55 120 Q40 155 55 170" stroke="#8e44ad" stroke-width="10" fill="none" stroke-linecap="round"/>
        <path d="M72 128 Q58 160 70 178" stroke="#8e44ad" stroke-width="9" fill="none" stroke-linecap="round"/>
        <path d="M90 132 Q82 165 92 180" stroke="#8e44ad" stroke-width="9" fill="none" stroke-linecap="round"/>
        <path d="M108 132 Q116 165 108 180" stroke="#8e44ad" stroke-width="9" fill="none" stroke-linecap="round"/>
        <path d="M126 128 Q140 160 130 178" stroke="#8e44ad" stroke-width="9" fill="none" stroke-linecap="round"/>
        <path d="M143 120 Q158 155 143 170" stroke="#8e44ad" stroke-width="10" fill="none" stroke-linecap="round"/>
      </g>
      <circle cx="70" cy="96" r="3.5" fill="rgba(255,255,255,0.15)"/>
      <circle cx="130" cy="96" r="3.5" fill="rgba(255,255,255,0.15)"/>
      <circle cx="100" cy="110" r="3" fill="rgba(255,255,255,0.12)"/>
      <rect x="72" y="38" width="56" height="8" rx="4" fill="#f1c40f"/>
      <rect x="82" y="12" width="36" height="30" rx="4" fill="#f1c40f"/>
      <text x="100" y="33" text-anchor="middle" font-size="14" font-weight="bold" fill="#9b59b6">‚òÖ</text>
      <defs>
        <radialGradient id="bodyGrad2" cx="40%" cy="35%">
          <stop offset="0%" stop-color="rgba(255,255,255,0.13)"/>
          <stop offset="100%" stop-color="rgba(0,0,0,0)"/>
        </radialGradient>
      </defs>
    </svg>
  </div>
  <div class="round-picker-wrap">
    <button class="round-badge" id="roundBadge">Round 1</button>
    <div class="round-picker" id="roundPicker"></div>
  </div>
</div>

<!-- Start screen -->
<div class="start-screen" id="startScreen">
  <svg class="octopus-svg" width="160" height="160" viewBox="0 0 200 200">
    <!-- body -->
    <ellipse cx="100" cy="85" rx="55" ry="50" fill="#9b59b6"/>
    <ellipse cx="100" cy="85" rx="55" ry="50" fill="url(#bodyGrad)"/>
    <!-- face highlight -->
    <ellipse cx="88" cy="72" rx="18" ry="14" fill="rgba(255,255,255,0.12)"/>
    <!-- eyes -->
    <ellipse cx="82" cy="82" rx="12" ry="13" fill="#fff"/>
    <ellipse cx="118" cy="82" rx="12" ry="13" fill="#fff"/>
    <circle cx="84" cy="83" r="6" fill="#2c1654"/>
    <circle cx="120" cy="83" r="6" fill="#2c1654"/>
    <circle cx="86" cy="81" r="2.2" fill="#fff"/>
    <circle cx="122" cy="81" r="2.2" fill="#fff"/>
    <!-- mouth -->
    <path d="M90 100 Q100 110 110 100" stroke="#2c1654" stroke-width="2.5" fill="none" stroke-linecap="round"/>
    <!-- tentacles -->
    <path d="M55 120 Q40 155 55 170" stroke="#8e44ad" stroke-width="10" fill="none" stroke-linecap="round"/>
    <path d="M72 128 Q58 160 70 178" stroke="#8e44ad" stroke-width="9" fill="none" stroke-linecap="round"/>
    <path d="M90 132 Q82 165 92 180" stroke="#8e44ad" stroke-width="9" fill="none" stroke-linecap="round"/>
    <path d="M108 132 Q116 165 108 180" stroke="#8e44ad" stroke-width="9" fill="none" stroke-linecap="round"/>
    <path d="M126 128 Q140 160 130 178" stroke="#8e44ad" stroke-width="9" fill="none" stroke-linecap="round"/>
    <path d="M143 120 Q158 155 143 170" stroke="#8e44ad" stroke-width="10" fill="none" stroke-linecap="round"/>
    <!-- spots -->
    <circle cx="70" cy="96" r="3.5" fill="rgba(255,255,255,0.15)"/>
    <circle cx="130" cy="96" r="3.5" fill="rgba(255,255,255,0.15)"/>
    <circle cx="100" cy="110" r="3" fill="rgba(255,255,255,0.12)"/>
    <!-- hat -->
    <rect x="72" y="38" width="56" height="8" rx="4" fill="#f1c40f"/>
    <rect x="82" y="12" width="36" height="30" rx="4" fill="#f1c40f"/>
    <text x="100" y="33" text-anchor="middle" font-size="14" font-weight="bold" fill="#9b59b6">‚òÖ</text>
    <defs>
      <radialGradient id="bodyGrad" cx="40%" cy="35%">
        <stop offset="0%" stop-color="rgba(255,255,255,0.13)"/>
        <stop offset="100%" stop-color="rgba(0,0,0,0)"/>
      </radialGradient>
    </defs>
  </svg>
  <h2>Octo-Math!</h2>
  <p>Answer 10 math questions per round. Get them right and Professor Octo will do a silly dance!</p>
  <button class="start-btn" id="startBtn">Let's Go! üöÄ</button>
</div>

<!-- Game area -->
<div class="main" id="gameArea" style="display:none;">
  <!-- Score dots -->
  <div class="score-bar" id="scoreDots"></div>

  <!-- Progress -->
  <div class="progress-wrap">
    <div class="progress-label">
      <span id="progressText">Question 1 of 10</span>
      <span id="scoreText">Score: 0</span>
    </div>
    <div class="progress-track">
      <div class="progress-fill" id="progressFill"></div>
    </div>
  </div>

  <!-- Question -->
  <div class="question-card" id="questionCard">
    <div class="level-tag" id="levelTag">Kindergarten</div>
    <div class="question-text" id="questionText">3 + 2 = ?</div>
    <div class="feedback-text" id="feedbackText"></div>
  </div>

  <!-- Answer + numpad -->
  <div class="answer-area" id="answerArea">
    <div class="answer-display" id="answerDisplay"><span class="cursor"></span></div>
    <div class="numpad" id="numpad">
      <button class="num-btn" data-val="1">1</button>
      <button class="num-btn" data-val="2">2</button>
      <button class="num-btn" data-val="3">3</button>
      <button class="num-btn" data-val="4">4</button>
      <button class="num-btn" data-val="5">5</button>
      <button class="num-btn" data-val="6">6</button>
      <button class="num-btn" data-val="7">7</button>
      <button class="num-btn" data-val="8">8</button>
      <button class="num-btn" data-val="9">9</button>
      <button class="num-btn zero" data-val="0">0</button>
      <button class="num-btn backspace" data-val="back">‚å´</button>
      <button class="num-btn submit-btn" data-val="submit">GO!</button>
    </div>
  </div>
</div>

<!-- Round summary overlay -->
<div class="overlay" id="overlay">
  <div class="summary-card">
    <div class="summary-emoji" id="summaryEmoji">üéâ</div>
    <div class="summary-title" id="summaryTitle">Great Job!</div>
    <div class="summary-score" id="summaryScore">8 <span class="of">/ 10</span></div>
    <div class="summary-msg" id="summaryMsg">You're getting smarter every round!</div>
    <div class="summary-btns">
      <button class="summary-btn btn-primary" id="nextRoundBtn">Next Round ‚Üí</button>
      <a href="../index.html" class="summary-btn btn-secondary" style="text-decoration:none;text-align:center;">Back to Home</a>
    </div>
  </div>
</div>

<script>
// ==================== GAME ENGINE ====================

const QUESTIONS_PER_ROUND = 10;

// Difficulty levels with question generators
const LEVELS = [
  {
    name: 'Kindergarten',
    generate() {
      // Addition 0-5
      const a = rand(0, 5), b = rand(0, 5);
      return { text: `${a} + ${b}`, answer: a + b };
    }
  },
  {
    name: 'Grade 1 - Easy',
    generate() {
      // Addition 0-10
      const a = rand(1, 10), b = rand(1, 10);
      return { text: `${a} + ${b}`, answer: a + b };
    }
  },
  {
    name: 'Grade 1',
    generate() {
      // Addition & subtraction 0-10
      if (Math.random() < 0.5) {
        const a = rand(1, 10), b = rand(1, 10);
        return { text: `${a} + ${b}`, answer: a + b };
      } else {
        const b = rand(1, 8), a = rand(b, 10);
        return { text: `${a} ‚àí ${b}`, answer: a - b };
      }
    }
  },
  {
    name: 'Grade 1 - Hard',
    generate() {
      // Larger addition & subtraction
      if (Math.random() < 0.5) {
        const a = rand(5, 15), b = rand(1, 10);
        return { text: `${a} + ${b}`, answer: a + b };
      } else {
        const b = rand(1, 10), a = rand(b + 2, 18);
        return { text: `${a} ‚àí ${b}`, answer: a - b };
      }
    }
  },
  {
    name: 'Grade 2 - Easy',
    generate() {
      // Double-digit addition/subtraction, easy multiplication
      const r = Math.random();
      if (r < 0.35) {
        const a = rand(10, 30), b = rand(1, 15);
        return { text: `${a} + ${b}`, answer: a + b };
      } else if (r < 0.7) {
        const b = rand(1, 12), a = rand(b + 5, 30);
        return { text: `${a} ‚àí ${b}`, answer: a - b };
      } else {
        const a = rand(1, 5), b = rand(1, 5);
        return { text: `${a} √ó ${b}`, answer: a * b };
      }
    }
  },
  {
    name: 'Grade 2',
    generate() {
      const r = Math.random();
      if (r < 0.3) {
        const a = rand(10, 50), b = rand(5, 30);
        return { text: `${a} + ${b}`, answer: a + b };
      } else if (r < 0.6) {
        const b = rand(5, 20), a = rand(b + 5, 50);
        return { text: `${a} ‚àí ${b}`, answer: a - b };
      } else {
        const a = rand(2, 6), b = rand(2, 6);
        return { text: `${a} √ó ${b}`, answer: a * b };
      }
    }
  },
  {
    name: 'Grade 2 - Hard',
    generate() {
      const r = Math.random();
      if (r < 0.25) {
        const a = rand(20, 80), b = rand(10, 50);
        return { text: `${a} + ${b}`, answer: a + b };
      } else if (r < 0.5) {
        const b = rand(10, 30), a = rand(b + 10, 80);
        return { text: `${a} ‚àí ${b}`, answer: a - b };
      } else if (r < 0.8) {
        const a = rand(2, 9), b = rand(2, 9);
        return { text: `${a} √ó ${b}`, answer: a * b };
      } else {
        const b = rand(2, 5), ans = rand(1, 6);
        return { text: `${b * ans} √∑ ${b}`, answer: ans };
      }
    }
  },
  {
    name: 'Grade 3',
    generate() {
      const r = Math.random();
      if (r < 0.2) {
        const a = rand(50, 200), b = rand(20, 150);
        return { text: `${a} + ${b}`, answer: a + b };
      } else if (r < 0.4) {
        const b = rand(20, 100), a = rand(b + 20, 250);
        return { text: `${a} ‚àí ${b}`, answer: a - b };
      } else if (r < 0.7) {
        const a = rand(3, 12), b = rand(3, 12);
        return { text: `${a} √ó ${b}`, answer: a * b };
      } else {
        const b = rand(2, 9), ans = rand(2, 10);
        return { text: `${b * ans} √∑ ${b}`, answer: ans };
      }
    }
  }
];

// State
let state = {
  round: 1,
  level: 0,          // index into LEVELS
  questionNum: 0,     // 0-based within round
  score: 0,           // correct in current round
  totalCorrect: 0,
  totalQuestions: 0,
  currentQuestion: null,
  answered: false,
  answerInput: '',
  results: [],        // per-round: true/false array
  streak: 0           // consecutive correct
};

// DOM refs
const $ = id => document.getElementById(id);
const startScreen = $('startScreen');
const gameArea = $('gameArea');
const topBar = $('topBar');
const roundBadge = $('roundBadge');
const scoreDots = $('scoreDots');
const progressFill = $('progressFill');
const progressText = $('progressText');
const scoreText = $('scoreText');
const questionCard = $('questionCard');
const levelTag = $('levelTag');
const questionText = $('questionText');
const feedbackText = $('feedbackText');
const answerDisplay = $('answerDisplay');
const answerArea = $('answerArea');
const numpad = $('numpad');
const overlay = $('overlay');
const octoArea = $('octoArea');
const speechBubble = $('speechBubble');
const octoEyes = $('octoEyes');
const octoMouth = $('octoMouth');

// Helpers
function rand(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

function setOctoFace(mode) {
  // mode: 'normal', 'silly', 'sad', 'thinking'
  if (mode === 'silly') {
    octoEyes.innerHTML = `
      <ellipse cx="82" cy="82" rx="12" ry="13" fill="#fff"/>
      <ellipse cx="118" cy="82" rx="12" ry="13" fill="#fff"/>
      <circle cx="78" cy="80" r="7" fill="#2c1654"/>
      <circle cx="122" cy="86" r="7" fill="#2c1654"/>
      <circle cx="80" cy="78" r="2.5" fill="#fff"/>
      <circle cx="124" cy="84" r="2.5" fill="#fff"/>
      <ellipse cx="68" cy="72" rx="10" ry="3" fill="#e74c9c" opacity="0.4" transform="rotate(-10 68 72)"/>
      <ellipse cx="132" cy="72" rx="10" ry="3" fill="#e74c9c" opacity="0.4" transform="rotate(10 132 72)"/>
    `;
    octoMouth.innerHTML = `
      <ellipse cx="100" cy="104" rx="10" ry="7" fill="#2c1654"/>
      <ellipse cx="100" cy="101" rx="7" ry="3" fill="#e74c9c"/>
      <path d="M95 98 Q93 94 96 95" stroke="#2c1654" stroke-width="1" fill="none"/>
    `;
  } else if (mode === 'sad') {
    octoEyes.innerHTML = `
      <ellipse cx="82" cy="82" rx="12" ry="13" fill="#fff"/>
      <ellipse cx="118" cy="82" rx="12" ry="13" fill="#fff"/>
      <circle cx="84" cy="86" r="6" fill="#2c1654"/>
      <circle cx="120" cy="86" r="6" fill="#2c1654"/>
      <circle cx="86" cy="84" r="2" fill="#fff"/>
      <circle cx="122" cy="84" r="2" fill="#fff"/>
      <path d="M72 72 Q78 76 88 73" stroke="#2c1654" stroke-width="2" fill="none" stroke-linecap="round"/>
      <path d="M112 73 Q122 76 128 72" stroke="#2c1654" stroke-width="2" fill="none" stroke-linecap="round"/>
      <circle cx="75" cy="92" r="3" fill="#56d4ff" opacity="0.6"/>
    `;
    octoMouth.innerHTML = `
      <path d="M90 106 Q100 98 110 106" stroke="#2c1654" stroke-width="2.5" fill="none" stroke-linecap="round"/>
    `;
  } else if (mode === 'thinking') {
    octoEyes.innerHTML = `
      <ellipse cx="82" cy="82" rx="12" ry="13" fill="#fff"/>
      <ellipse cx="118" cy="82" rx="12" ry="13" fill="#fff"/>
      <circle cx="86" cy="80" r="6" fill="#2c1654"/>
      <circle cx="122" cy="80" r="6" fill="#2c1654"/>
      <circle cx="88" cy="78" r="2.2" fill="#fff"/>
      <circle cx="124" cy="78" r="2.2" fill="#fff"/>
    `;
    octoMouth.innerHTML = `
      <path d="M90 100 Q100 110 110 100" stroke="#2c1654" stroke-width="2.5" fill="none" stroke-linecap="round"/>
    `;
  } else { // normal
    octoEyes.innerHTML = `
      <ellipse cx="82" cy="82" rx="12" ry="13" fill="#fff"/>
      <ellipse cx="118" cy="82" rx="12" ry="13" fill="#fff"/>
      <circle cx="84" cy="83" r="6" fill="#2c1654"/>
      <circle cx="120" cy="83" r="6" fill="#2c1654"/>
      <circle cx="86" cy="81" r="2.2" fill="#fff"/>
      <circle cx="122" cy="81" r="2.2" fill="#fff"/>
    `;
    octoMouth.innerHTML = `
      <path d="M90 100 Q100 110 110 100" stroke="#2c1654" stroke-width="2.5" fill="none" stroke-linecap="round"/>
    `;
  }
}

function showSpeech(text, duration = 2000) {
  speechBubble.textContent = text;
  speechBubble.classList.add('visible');
  setTimeout(() => speechBubble.classList.remove('visible'), duration);
}

const sillyPhrases = [
  'üéâ Yay!', 'ü§© Woohoo!', '‚≠ê Super!', 'ü•≥ Amazing!', 'ü¶ë Ink-credible!',
  'üêô Tenta-cool!', 'üíú Nailed it!', 'üèÜ You rock!', '‚ú® Brilliant!', 'üåü Wow!'
];
const sadPhrases = [
  'Oh, womp womp üòî', 'Womp womp! üêô', 'Oh no, womp womp!', 'Womp womp üò¢'
];

function renderScoreDots() {
  let html = '';
  for (let i = 0; i < QUESTIONS_PER_ROUND; i++) {
    let cls = '';
    if (i < state.results.length) {
      cls = state.results[i] ? 'correct-dot' : 'wrong-dot';
    } else if (i === state.questionNum) {
      cls = 'current-dot';
    }
    html += `<div class="score-dot ${cls}"></div>`;
  }
  scoreDots.innerHTML = html;
}

function updateUI() {
  const lvl = LEVELS[Math.min(state.level, LEVELS.length - 1)];
  roundBadge.textContent = `Rd ${state.round} ‚ñæ`;
  progressText.textContent = `Question ${state.questionNum + 1} of ${QUESTIONS_PER_ROUND}`;
  scoreText.textContent = `Score: ${state.score}`;
  progressFill.style.width = ((state.questionNum) / QUESTIONS_PER_ROUND * 100) + '%';
  renderScoreDots();
}

function generateQuestion() {
  const lvl = LEVELS[Math.min(state.level, LEVELS.length - 1)];
  state.currentQuestion = lvl.generate();
  levelTag.textContent = lvl.name;
  questionText.textContent = state.currentQuestion.text + ' = ?';
  feedbackText.textContent = '';
  feedbackText.className = 'feedback-text';
  questionCard.className = 'question-card';
  state.answerInput = '';
  state.answered = false;
  answerDisplay.innerHTML = '<span class="cursor"></span>';
  showNumpad();
  setOctoFace('thinking');
  updateUI();
}

function showNumpad() {
  // Replace the next button with normal numpad
  const existingNext = numpad.querySelector('.next-btn');
  if (existingNext) existingNext.remove();
  numpad.querySelectorAll('.num-btn').forEach(b => b.style.display = '');
}

function handleInput(val) {
  if (state.answered) return;

  if (val === 'back') {
    state.answerInput = state.answerInput.slice(0, -1);
  } else if (val === 'submit') {
    if (state.answerInput === '') return;
    checkAnswer();
    return;
  } else {
    if (state.answerInput.length >= 4) return;
    // Handle leading minus? Not needed for current levels, all answers >= 0
    state.answerInput += val;
  }

  if (state.answerInput) {
    answerDisplay.innerHTML = state.answerInput + '<span class="cursor"></span>';
  } else {
    answerDisplay.innerHTML = '<span class="cursor"></span>';
  }
}

function checkAnswer() {
  const userAns = parseInt(state.answerInput, 10);
  const correct = state.currentQuestion.answer;
  state.answered = true;
  answerDisplay.innerHTML = state.answerInput;

  if (userAns === correct) {
    // Correct!
    state.score++;
    state.streak++;
    state.totalCorrect++;
    state.results.push(true);
    questionCard.classList.add('correct');
    feedbackText.textContent = `‚úÖ Correct! ${state.currentQuestion.text} = ${correct}`;
    feedbackText.className = 'feedback-text correct-fb';
    setOctoFace('silly');
    octoArea.classList.add('celebrate');
    showSpeech(sillyPhrases[rand(0, sillyPhrases.length - 1)]);
    setTimeout(() => octoArea.classList.remove('celebrate'), 600);
  } else {
    // Wrong
    state.streak = 0;
    state.results.push(false);
    questionCard.classList.add('wrong');
    feedbackText.textContent = `‚ùå The answer was ${correct}`;
    feedbackText.className = 'feedback-text wrong-fb';
    setOctoFace('sad');
    octoArea.classList.add('sad');
    showSpeech(sadPhrases[rand(0, sadPhrases.length - 1)], 2500);
    setTimeout(() => octoArea.classList.remove('sad'), 700);
  }

  state.totalQuestions++;
  renderScoreDots();
  scoreText.textContent = `Score: ${state.score}`;

  // Show next button
  numpad.querySelectorAll('.num-btn').forEach(b => b.style.display = 'none');
  const nextBtn = document.createElement('button');
  nextBtn.className = 'num-btn next-btn';
  nextBtn.dataset.val = 'next';
  nextBtn.textContent = state.questionNum + 1 >= QUESTIONS_PER_ROUND ? 'See Results! üéâ' : 'Next Question ‚Üí';
  numpad.appendChild(nextBtn);
}

function nextQuestion() {
  state.questionNum++;
  if (state.questionNum >= QUESTIONS_PER_ROUND) {
    endRound();
  } else {
    generateQuestion();
  }
}

function endRound() {
  // Adjust difficulty
  const pct = state.score / QUESTIONS_PER_ROUND;
  if (pct >= 0.8 && state.level < LEVELS.length - 1) {
    state.level++;
  } else if (pct < 0.4 && state.level > 0) {
    state.level--;
  }

  // Show summary
  const emoji = pct >= 0.9 ? 'üèÜ' : pct >= 0.7 ? 'üéâ' : pct >= 0.5 ? 'üëç' : 'üí™';
  const title = pct >= 0.9 ? 'AMAZING!' : pct >= 0.7 ? 'Great Job!' : pct >= 0.5 ? 'Nice Try!' : 'Keep Going!';
  const msgs = pct >= 0.9
    ? 'You are a math superstar! üåü'
    : pct >= 0.7
    ? "You're doing awesome, keep it up!"
    : pct >= 0.5
    ? "Good effort! Practice makes perfect!"
    : "Don't give up, you'll get better!";

  $('summaryEmoji').textContent = emoji;
  $('summaryTitle').textContent = title;
  $('summaryScore').innerHTML = `${state.score} <span class="of">/ ${QUESTIONS_PER_ROUND}</span>`;
  $('summaryMsg').textContent = msgs;
  overlay.classList.add('visible');

  if (pct >= 0.8) fireConfetti();

  progressFill.style.width = '100%';
}

function startNewRound() {
  overlay.classList.remove('visible');
  state.round++;
  state.questionNum = 0;
  state.score = 0;
  state.results = [];
  setOctoFace('normal');
  generateQuestion();
}

// Confetti
function fireConfetti() {
  const canvas = $('confetti');
  const ctx = canvas.getContext('2d');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  const pieces = [];
  const colors = ['#ffe156','#ff6b9d','#56d4ff','#7cff6b','#b56bff','#ff9f43','#fff'];

  for (let i = 0; i < 120; i++) {
    pieces.push({
      x: canvas.width / 2 + (Math.random() - 0.5) * 100,
      y: canvas.height * 0.4,
      vx: (Math.random() - 0.5) * 14,
      vy: -Math.random() * 16 - 4,
      w: rand(5, 10),
      h: rand(3, 6),
      color: colors[rand(0, colors.length - 1)],
      rot: Math.random() * 360,
      rv: (Math.random() - 0.5) * 12,
      gravity: 0.35
    });
  }

  let frame = 0;
  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    let alive = false;
    pieces.forEach(p => {
      p.x += p.vx;
      p.vy += p.gravity;
      p.y += p.vy;
      p.rot += p.rv;
      if (p.y < canvas.height + 50) alive = true;
      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot * Math.PI / 180);
      ctx.fillStyle = p.color;
      ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
      ctx.restore();
    });
    frame++;
    if (alive && frame < 180) requestAnimationFrame(draw);
    else ctx.clearRect(0, 0, canvas.width, canvas.height);
  }
  draw();
}

// Events
$('startBtn').addEventListener('click', () => {
  startScreen.style.display = 'none';
  gameArea.style.display = 'flex';
  topBar.style.display = 'flex';
  generateQuestion();
});

numpad.addEventListener('click', e => {
  const btn = e.target.closest('.num-btn');
  if (!btn) return;
  const val = btn.dataset.val;
  if (val === 'next') {
    nextQuestion();
  } else {
    handleInput(val);
  }
});

// Keyboard support (desktop)
document.addEventListener('keydown', e => {
  if (startScreen.style.display !== 'none') return;
  if (overlay.classList.contains('visible')) {
    if (e.key === 'Enter') { startNewRound(); e.preventDefault(); }
    return;
  }
  if (state.answered) {
    if (e.key === 'Enter' || e.key === ' ') { nextQuestion(); e.preventDefault(); }
    return;
  }
  if (e.key >= '0' && e.key <= '9') handleInput(e.key);
  else if (e.key === 'Backspace') handleInput('back');
  else if (e.key === 'Enter') handleInput('submit');
});

$('nextRoundBtn').addEventListener('click', startNewRound);

// Round picker
const roundPicker = $('roundPicker');
function buildRoundPicker() {
  let html = '';
  LEVELS.forEach((lvl, i) => {
    const active = i === state.level ? ' active' : '';
    html += `<button class="round-picker-option${active}" data-level="${i}">${lvl.name}</button>`;
  });
  roundPicker.innerHTML = html;
}
roundBadge.addEventListener('click', (e) => {
  e.stopPropagation();
  buildRoundPicker();
  roundPicker.classList.toggle('visible');
});
roundPicker.addEventListener('click', (e) => {
  const opt = e.target.closest('.round-picker-option');
  if (!opt) return;
  const lvl = parseInt(opt.dataset.level, 10);
  state.level = lvl;
  state.questionNum = 0;
  state.score = 0;
  state.results = [];
  roundPicker.classList.remove('visible');
  setOctoFace('normal');
  generateQuestion();
});
document.addEventListener('click', () => {
  roundPicker.classList.remove('visible');
});

// Background particles
const pCont = $('particles');
for (let i = 0; i < 20; i++) {
  const p = document.createElement('div');
  p.className = 'particle';
  const size = rand(4, 12);
  p.style.width = size + 'px';
  p.style.height = size + 'px';
  p.style.left = Math.random() * 100 + '%';
  p.style.background = ['#9b59b6','#8e44ad','#b56bff','#d4a5ff'][rand(0,3)];
  p.style.animationDuration = (8 + Math.random() * 12) + 's';
  p.style.animationDelay = (Math.random() * 10) + 's';
  pCont.appendChild(p);
}
</script>
</body>
</html>
