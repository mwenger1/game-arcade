<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Snow Day Games!</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Lilita+One&family=Nunito:wght@600;700;800;900&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; overflow: hidden; }
body {
  font-family: 'Nunito', sans-serif;
  background: #0f1a2e;
  color: #fff;
  -webkit-tap-highlight-color: transparent;
  user-select: none; -webkit-user-select: none;
}

/* ===== MENU ===== */
#menu {
  position: fixed; inset: 0; z-index: 10;
  display: flex; flex-direction: column;
  align-items: center; padding: 1.5rem;
  overflow-y: auto;
  background: linear-gradient(160deg, #0f1a30 0%, #1b3055 45%, #162848 100%);
}
#menu.hidden { display: none; }

.menu-title {
  font-family: 'Lilita One', cursive;
  font-size: clamp(2rem, 8vw, 3.2rem);
  margin-top: 1.5rem; margin-bottom: 0.1rem;
  text-align: center;
  background: linear-gradient(135deg, #ff6b6b, #fff 40%, #56d4ff 70%, #b56bff);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text;
}
.menu-sub {
  color: rgba(255,255,255,0.3); font-weight: 700;
  font-size: 0.78rem; margin-bottom: 1.6rem;
  text-align: center; letter-spacing: 0.3px;
}
.cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(min(260px, 100%), 1fr));
  gap: 0.9rem; width: 100%; max-width: 720px;
  padding-bottom: 2rem;
}
.card {
  background: rgba(255,255,255,0.04);
  border: 1px solid rgba(255,255,255,0.07);
  border-radius: 1.1rem; padding: 1.2rem;
  cursor: pointer;
  transition: transform 0.18s, box-shadow 0.18s, border-color 0.18s;
  display: flex; flex-direction: column; align-items: center;
  text-align: center; text-decoration: none; color: #fff;
}
.card:hover, .card:active {
  transform: translateY(-3px) scale(1.01);
  border-color: rgba(255,255,255,0.16);
  box-shadow: 0 8px 32px rgba(0,0,0,0.3);
}
.card-icon {
  width: 64px; height: 64px; border-radius: 1rem;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.7rem; margin-bottom: 0.65rem;
}
.card-title {
  font-family: 'Lilita One', cursive;
  font-size: 1.15rem; margin-bottom: 0.2rem;
}
.card-desc {
  color: rgba(255,255,255,0.35); font-weight: 600;
  font-size: 0.72rem; line-height: 1.4;
}
.card[data-game="math"] .card-icon { background: rgba(181,107,255,0.13); }
.card[data-game="ski"] .card-icon { background: rgba(46,204,113,0.13); }
.card[data-game="snowball"] .card-icon { background: rgba(86,212,255,0.13); }

.footer-note {
  color: rgba(255,255,255,0.15); font-size: 0.55rem;
  font-weight: 700; text-align: center;
  margin-top: auto; padding-top: 1rem;
}

/* Snow deco */
.sdeco { position: fixed; inset: 0; pointer-events: none; z-index: 0; overflow: hidden; }
.sf {
  position: absolute; color: #fff; opacity: 0;
  animation: sfl linear infinite;
}
@keyframes sfl {
  0% { transform: translateY(-5vh) translateX(0) rotate(0); opacity: 0; }
  8% { opacity: var(--o,0.3); } 92% { opacity: var(--o,0.3); }
  100% { transform: translateY(105vh) translateX(var(--d,20px)) rotate(360deg); opacity: 0; }
}

/* ===== GAME IFRAME ===== */
#gameFrame {
  position: fixed; inset: 0; z-index: 20;
  border: none; width: 100%; height: 100%;
  display: none; background: #000;
}
#gameFrame.active { display: block; }
</style>
</head>
<body>

<div class="sdeco" id="sdeco"></div>

<div id="menu">
  <div class="menu-title">Snow Day Games!</div>
  <div class="menu-sub">Pick a game and play together</div>

  <div class="cards">
    <div class="card" data-game="math" onclick="launchGame('math')">
      <div class="card-icon">üêô</div>
      <div class="card-title">Octo-Math!</div>
      <div class="card-desc">Help the octopus solve math puzzles across 12 ocean-themed levels!</div>
    </div>
    <div class="card" data-game="ski" onclick="launchGame('ski')">
      <div class="card-icon">‚õ∑Ô∏è</div>
      <div class="card-title">Ski & Snow!</div>
      <div class="card-desc">Race downhill, dodge trees and rocks, grab coins and power-ups!</div>
    </div>
    <div class="card" data-game="snowball" onclick="launchGame('snowball')">
      <div class="card-icon">‚ùÑÔ∏è</div>
      <div class="card-title">Snowball Fight!</div>
      <div class="card-desc">Duck and throw in an epic 4v4 winter battle! First to 13 wins!</div>
    </div>
  </div>

  <div class="footer-note">Built with love for snow days together</div>
</div>

<iframe id="gameFrame" sandbox="allow-scripts allow-same-origin" allowfullscreen></iframe>

<script>
// ===== MENU SNOWFLAKES =====
const sdc = document.getElementById('sdeco');
for (let i = 0; i < 30; i++) {
  const s = document.createElement('div');
  s.className = 'sf';
  s.textContent = ['\u2744','\u2745','\u2746','\u2022'][Math.floor(Math.random()*4)];
  s.style.left = Math.random()*100+'%';
  s.style.fontSize = (0.5+Math.random()*0.85)+'rem';
  s.style.setProperty('--o',(0.12+Math.random()*0.3).toFixed(2));
  s.style.setProperty('--d',(Math.random()-0.5)*50+'px');
  s.style.animationDuration = (5+Math.random()*7)+'s';
  s.style.animationDelay = Math.random()*7+'s';
  sdc.appendChild(s);
}

// ===== GAME HTML STORAGE =====
const GAMES = {};
GAMES['math'] = `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Octo-Math!</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Lilita+One&family=Nunito:wght@600;700;800;900&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg-deep: #1a0a2e;
    --bg-mid: #2d1b69;
    --purple-light: #b56bff;
    --purple-mid: #8b3fd4;
    --purple-dark: #5c1f9e;
    --green-correct: #4cdb6a;
    --green-glow: rgba(76,219,106,0.3);
    --red-wrong: #ff5c6a;
    --red-glow: rgba(255,92,106,0.3);
    --yellow: #ffe156;
    --cyan: #56d4ff;
    --pink: #ff6b9d;
    --card-bg: rgba(255,255,255,0.06);
    --card-border: rgba(255,255,255,0.1);
  }

  html, body { height: 100%; }

  body {
    font-family: 'Nunito', sans-serif;
    background: linear-gradient(160deg, var(--bg-deep) 0%, var(--bg-mid) 50%, #1e0e3e 100%);
    color: #fff;
    min-height: 100dvh;
    overflow-x: hidden;
    display: flex;
    flex-direction: column;
    -webkit-tap-highlight-color: transparent;
  }

  /* Top bar */
  .top-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.8rem 1rem;
    background: rgba(0,0,0,0.25);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    position: sticky;
    top: 0;
    z-index: 50;
  }
  .back-btn {
    display: flex; align-items: center; gap: 0.3rem;
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.12);
    color: #ccc;
    font-family: 'Nunito', sans-serif;
    font-weight: 700;
    font-size: 0.85rem;
    padding: 0.45rem 0.9rem;
    border-radius: 2rem;
    cursor: pointer;
    text-decoration: none;
    transition: background 0.2s;
  }
  .back-btn:hover { background: rgba(255,255,255,0.14); color: #fff; }
  .top-title {
    font-family: 'Lilita One', cursive;
    font-size: 1.1rem;
    color: var(--purple-light);
  }
  .round-badge-base, .round-badge {
    background: rgba(181,107,255,0.18);
    border: 1px solid rgba(181,107,255,0.3);
    color: var(--purple-light);
    font-weight: 800;
    font-size: 0.78rem;
    padding: 0.35rem 0.7rem;
    border-radius: 2rem;
  }

  /* Main area */
  .main {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    max-width: 500px;
    width: 100%;
    margin: 0 auto;
    padding: 1rem 1rem 2rem;
  }

  /* Progress bar */
  .progress-wrap {
    width: 100%;
    margin-bottom: 1rem;
  }
  .progress-label {
    display: flex;
    justify-content: space-between;
    font-size: 0.75rem;
    font-weight: 700;
    color: rgba(255,255,255,0.5);
    margin-bottom: 0.35rem;
  }
  .progress-track {
    width: 100%;
    height: 10px;
    background: rgba(255,255,255,0.08);
    border-radius: 99px;
    overflow: hidden;
  }
  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--purple-mid), var(--purple-light));
    border-radius: 99px;
    transition: width 0.5s ease;
    width: 0%;
  }

  /* Octopus character */
  .octopus-area {
    position: relative;
    width: 180px;
    height: 180px;
    margin: 0.5rem 0 0.8rem;
    flex-shrink: 0;
  }

  .octopus-svg {
    width: 100%;
    height: 100%;
    transition: transform 0.3s;
  }

  .octopus-area.celebrate .octopus-svg {
    animation: octoWiggle 0.5s ease-in-out;
  }
  .octopus-area.sad .octopus-svg {
    animation: octoSad 0.6s ease-in-out;
  }

  @keyframes octoWiggle {
    0% { transform: rotate(0deg) scale(1); }
    20% { transform: rotate(-8deg) scale(1.1); }
    40% { transform: rotate(8deg) scale(1.1); }
    60% { transform: rotate(-5deg) scale(1.05); }
    80% { transform: rotate(5deg) scale(1.05); }
    100% { transform: rotate(0deg) scale(1); }
  }
  @keyframes octoSad {
    0% { transform: translateY(0); }
    30% { transform: translateY(6px); }
    100% { transform: translateY(0); }
  }

  /* Speech bubble */
  .speech-bubble {
    position: absolute;
    top: -8px;
    right: -60px;
    background: #fff;
    color: #333;
    font-weight: 800;
    font-size: 0.78rem;
    padding: 0.4rem 0.7rem;
    border-radius: 1rem;
    box-shadow: 0 3px 12px rgba(0,0,0,0.2);
    opacity: 0;
    transform: scale(0.8);
    transition: all 0.3s;
    pointer-events: none;
    white-space: nowrap;
    z-index: 5;
  }
  .speech-bubble.visible {
    opacity: 1;
    transform: scale(1);
  }
  .speech-bubble::after {
    content: '';
    position: absolute;
    bottom: -6px;
    left: 18px;
    width: 12px; height: 12px;
    background: #fff;
    transform: rotate(45deg);
    border-radius: 2px;
  }

  /* Question card */
  .question-card {
    width: 100%;
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 1.4rem;
    padding: 1.5rem;
    text-align: center;
    margin-bottom: 1rem;
    min-height: 90px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    transition: border-color 0.3s, box-shadow 0.3s;
  }
  .question-card.correct {
    border-color: var(--green-correct);
    box-shadow: 0 0 25px var(--green-glow);
  }
  .question-card.wrong {
    border-color: var(--red-wrong);
    box-shadow: 0 0 25px var(--red-glow);
  }

  .level-tag {
    font-size: 0.7rem;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--purple-light);
    margin-bottom: 0.5rem;
  }

  .question-text {
    font-family: 'Lilita One', cursive;
    font-size: clamp(2rem, 8vw, 3rem);
    letter-spacing: 2px;
    color: #fff;
  }

  .feedback-text {
    margin-top: 0.6rem;
    font-weight: 800;
    font-size: 1rem;
    min-height: 1.4rem;
  }
  .feedback-text.correct-fb { color: var(--green-correct); }
  .feedback-text.wrong-fb { color: var(--red-wrong); }

  /* Answer input area */
  .answer-area {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.8rem;
  }

  .answer-display {
    font-family: 'Lilita One', cursive;
    font-size: 2.6rem;
    color: var(--yellow);
    min-height: 3.2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    letter-spacing: 3px;
  }
  .answer-display .cursor {
    display: inline-block;
    width: 2px;
    height: 2.2rem;
    background: var(--yellow);
    margin-left: 2px;
    animation: blink 1s step-end infinite;
  }
  @keyframes blink { 50% { opacity: 0; } }

  /* Numpad */
  .numpad {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.55rem;
    width: 100%;
    max-width: 320px;
  }

  .num-btn {
    font-family: 'Nunito', sans-serif;
    font-weight: 900;
    font-size: 1.5rem;
    color: #fff;
    background: rgba(255,255,255,0.08);
    border: 1.5px solid rgba(255,255,255,0.12);
    border-radius: 1rem;
    padding: 0.9rem;
    cursor: pointer;
    transition: transform 0.1s, background 0.15s;
    user-select: none;
    -webkit-user-select: none;
  }
  .num-btn:active {
    transform: scale(0.93);
    background: rgba(255,255,255,0.16);
  }
  .num-btn.zero { grid-column: 1 / 2; }
  .num-btn.backspace {
    background: rgba(255,92,106,0.12);
    border-color: rgba(255,92,106,0.25);
    font-size: 1.3rem;
  }
  .num-btn.submit-btn {
    background: linear-gradient(135deg, var(--purple-mid), var(--purple-light));
    border-color: transparent;
    font-size: 1.1rem;
    letter-spacing: 1px;
  }
  .num-btn.submit-btn:active {
    transform: scale(0.93);
    filter: brightness(1.15);
  }
  .num-btn.next-btn {
    grid-column: 1 / -1;
    background: linear-gradient(135deg, #2d8f44, var(--green-correct));
    border-color: transparent;
    font-size: 1.1rem;
    padding: 1rem;
    letter-spacing: 1px;
  }
  .num-btn.next-btn:active { filter: brightness(1.15); }

  /* Score display */
  .score-bar {
    display: flex;
    justify-content: center;
    gap: 0.3rem;
    margin-bottom: 0.8rem;
    flex-wrap: wrap;
  }
  .score-dot {
    width: 22px; height: 22px;
    border-radius: 50%;
    background: rgba(255,255,255,0.1);
    border: 2px solid rgba(255,255,255,0.15);
    transition: all 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.6rem;
  }
  .score-dot.correct-dot {
    background: var(--green-correct);
    border-color: var(--green-correct);
    box-shadow: 0 0 8px var(--green-glow);
  }
  .score-dot.wrong-dot {
    background: var(--red-wrong);
    border-color: var(--red-wrong);
    box-shadow: 0 0 8px var(--red-glow);
  }
  .score-dot.current-dot {
    border-color: var(--yellow);
    box-shadow: 0 0 8px rgba(255,225,86,0.4);
  }

  /* Round summary overlay */
  .overlay {
    position: fixed;
    inset: 0;
    background: rgba(10,5,20,0.92);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1.5rem;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.35s;
  }
  .overlay.visible { opacity: 1; pointer-events: auto; }

  .summary-card {
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 1.6rem;
    padding: 2rem 1.5rem;
    text-align: center;
    max-width: 380px;
    width: 100%;
    transform: scale(0.9);
    transition: transform 0.35s;
  }
  .overlay.visible .summary-card { transform: scale(1); }

  .summary-emoji { font-size: 3rem; margin-bottom: 0.5rem; }
  .summary-title {
    font-family: 'Lilita One', cursive;
    font-size: 1.8rem;
    margin-bottom: 0.3rem;
  }
  .summary-score {
    font-size: 3rem;
    font-weight: 900;
    margin: 0.5rem 0;
  }
  .summary-score .of { font-size: 1.2rem; color: var(--purple-light); }
  .summary-msg { color: rgba(255,255,255,0.6); font-weight: 700; font-size: 0.9rem; margin-bottom: 1.2rem; }

  .summary-btns {
    display: flex;
    flex-direction: column;
    gap: 0.6rem;
  }
  .summary-btn {
    font-family: 'Nunito', sans-serif;
    font-weight: 800;
    font-size: 1rem;
    padding: 0.9rem;
    border: none;
    border-radius: 1rem;
    cursor: pointer;
    transition: transform 0.15s, filter 0.15s;
  }
  .summary-btn:active { transform: scale(0.96); }
  .btn-primary {
    background: linear-gradient(135deg, var(--purple-mid), var(--purple-light));
    color: #fff;
  }
  .btn-secondary {
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.12);
    color: #ccc;
  }

  /* Confetti canvas */
  #confetti {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 200;
  }

  /* Start screen */
  .start-screen {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 1.5rem 1.2rem 2rem;
    gap: 0.8rem;
    overflow-y: auto;
  }
  .start-screen h2 {
    font-family: 'Lilita One', cursive;
    font-size: clamp(2rem, 7vw, 2.8rem);
    background: linear-gradient(135deg, var(--purple-light), var(--pink));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  .start-screen p { color: rgba(255,255,255,0.55); font-weight: 700; max-width: 300px; }
  .start-btn {
    font-family: 'Nunito', sans-serif;
    font-weight: 800;
    font-size: 1.2rem;
    padding: 1rem 2.5rem;
    background: linear-gradient(135deg, var(--purple-mid), var(--purple-light));
    color: #fff;
    border: none;
    border-radius: 1.2rem;
    cursor: pointer;
    margin-top: 0.5rem;
    transition: transform 0.15s;
    flex-shrink: 0;
  }
  .start-btn:active { transform: scale(0.95); }

  /* Level picker (shared between start screen and in-game drawer) */
  .level-picker-label {
    font-family: 'Lilita One', cursive;
    font-size: 1rem;
    color: rgba(255,255,255,0.6);
    letter-spacing: 0.5px;
    margin-bottom: 0.2rem;
  }
  .level-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.5rem;
    width: 100%;
    max-width: 360px;
  }
  .level-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.65rem 0.8rem;
    background: rgba(255,255,255,0.05);
    border: 2px solid rgba(255,255,255,0.08);
    border-radius: 0.9rem;
    color: #ccc;
    font-family: 'Nunito', sans-serif;
    font-weight: 700;
    font-size: 0.78rem;
    cursor: pointer;
    transition: all 0.2s;
    text-align: left;
    -webkit-tap-highlight-color: transparent;
  }
  .level-btn:active { transform: scale(0.96); }
  .level-btn.selected {
    border-color: var(--purple-light);
    background: rgba(181,107,255,0.15);
    color: #fff;
    box-shadow: 0 0 14px rgba(181,107,255,0.2);
  }
  .level-num {
    width: 26px; height: 26px;
    border-radius: 50%;
    background: rgba(255,255,255,0.08);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 900;
    font-size: 0.75rem;
    flex-shrink: 0;
    color: rgba(255,255,255,0.5);
  }
  .level-btn.selected .level-num {
    background: var(--purple-mid);
    color: #fff;
  }
  .level-name { line-height: 1.2; }

  /* In-game level drawer (slide-up panel) */
  .level-drawer-overlay {
    position: fixed;
    inset: 0;
    background: rgba(10,5,20,0.7);
    z-index: 90;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s;
  }
  .level-drawer-overlay.visible { opacity: 1; pointer-events: auto; }

  .level-drawer {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    z-index: 91;
    background: linear-gradient(180deg, #2a1558, #1a0a2e);
    border-top: 1px solid rgba(181,107,255,0.2);
    border-radius: 1.4rem 1.4rem 0 0;
    padding: 1.2rem 1.2rem 2rem;
    transform: translateY(100%);
    transition: transform 0.3s ease-out;
    max-height: 70vh;
    overflow-y: auto;
  }
  .level-drawer-overlay.visible .level-drawer { transform: translateY(0); }

  .drawer-handle {
    width: 40px; height: 4px;
    background: rgba(255,255,255,0.2);
    border-radius: 2px;
    margin: 0 auto 0.8rem;
  }
  .drawer-title {
    font-family: 'Lilita One', cursive;
    font-size: 1.1rem;
    text-align: center;
    margin-bottom: 0.8rem;
    color: var(--purple-light);
  }
  .drawer-current {
    text-align: center;
    font-size: 0.78rem;
    color: rgba(255,255,255,0.4);
    margin-bottom: 0.6rem;
    font-weight: 700;
  }
  .drawer-note {
    text-align: center;
    font-size: 0.7rem;
    color: rgba(255,255,255,0.3);
    margin-top: 0.8rem;
    font-weight: 600;
  }

  /* Make round badge tappable */
  .round-badge {
    cursor: pointer;
    transition: background 0.2s, transform 0.15s;
  }
  .round-badge:active { transform: scale(0.95); }
  .round-badge:hover { background: rgba(181,107,255,0.3); }

  /* Particles */
  .particles {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 0;
    overflow: hidden;
  }
  .particle {
    position: absolute;
    border-radius: 50%;
    opacity: 0.15;
    animation: floatUp linear infinite;
  }
  @keyframes floatUp {
    0% { transform: translateY(100vh) scale(0); opacity: 0; }
    10% { opacity: 0.15; }
    90% { opacity: 0.15; }
    100% { transform: translateY(-10vh) scale(1); opacity: 0; }
  }
</style>
</head>
<body>

<div class="particles" id="particles"></div>
<canvas id="confetti"></canvas>

<!-- Top bar -->
<div class="top-bar" id="topBar" style="display:none;">
  <a href="#" onclick="parent.postMessage(\\'back\\',\\'*\\');return false;" class="back-btn">‚Äπ Menu</a>
  <span class="top-title">üêô Octo-Math</span>
  <span class="round-badge" id="roundBadge" onclick="toggleLevelDrawer()">Round 1 ¬∑ Lvl 1 ‚ñæ</span>
</div>

<!-- Start screen -->
<div class="start-screen" id="startScreen">
  <svg class="octopus-svg" width="160" height="160" viewBox="0 0 200 200">
    <!-- body -->
    <ellipse cx="100" cy="85" rx="55" ry="50" fill="#9b59b6"/>
    <ellipse cx="100" cy="85" rx="55" ry="50" fill="url(#bodyGrad)"/>
    <!-- face highlight -->
    <ellipse cx="88" cy="72" rx="18" ry="14" fill="rgba(255,255,255,0.12)"/>
    <!-- eyes -->
    <ellipse cx="82" cy="82" rx="12" ry="13" fill="#fff"/>
    <ellipse cx="118" cy="82" rx="12" ry="13" fill="#fff"/>
    <circle cx="84" cy="83" r="6" fill="#2c1654"/>
    <circle cx="120" cy="83" r="6" fill="#2c1654"/>
    <circle cx="86" cy="81" r="2.2" fill="#fff"/>
    <circle cx="122" cy="81" r="2.2" fill="#fff"/>
    <!-- mouth -->
    <path d="M90 100 Q100 110 110 100" stroke="#2c1654" stroke-width="2.5" fill="none" stroke-linecap="round"/>
    <!-- tentacles -->
    <path d="M55 120 Q40 155 55 170" stroke="#8e44ad" stroke-width="10" fill="none" stroke-linecap="round"/>
    <path d="M72 128 Q58 160 70 178" stroke="#8e44ad" stroke-width="9" fill="none" stroke-linecap="round"/>
    <path d="M90 132 Q82 165 92 180" stroke="#8e44ad" stroke-width="9" fill="none" stroke-linecap="round"/>
    <path d="M108 132 Q116 165 108 180" stroke="#8e44ad" stroke-width="9" fill="none" stroke-linecap="round"/>
    <path d="M126 128 Q140 160 130 178" stroke="#8e44ad" stroke-width="9" fill="none" stroke-linecap="round"/>
    <path d="M143 120 Q158 155 143 170" stroke="#8e44ad" stroke-width="10" fill="none" stroke-linecap="round"/>
    <!-- spots -->
    <circle cx="70" cy="96" r="3.5" fill="rgba(255,255,255,0.15)"/>
    <circle cx="130" cy="96" r="3.5" fill="rgba(255,255,255,0.15)"/>
    <circle cx="100" cy="110" r="3" fill="rgba(255,255,255,0.12)"/>
    <!-- hat -->
    <rect x="72" y="38" width="56" height="8" rx="4" fill="#f1c40f"/>
    <rect x="82" y="12" width="36" height="30" rx="4" fill="#f1c40f"/>
    <text x="100" y="33" text-anchor="middle" font-size="14" font-weight="bold" fill="#9b59b6">‚òÖ</text>
    <defs>
      <radialGradient id="bodyGrad" cx="40%" cy="35%">
        <stop offset="0%" stop-color="rgba(255,255,255,0.13)"/>
        <stop offset="100%" stop-color="rgba(0,0,0,0)"/>
      </radialGradient>
    </defs>
  </svg>
  <h2>Octo-Math!</h2>
  <p>Answer 10 math questions per round. Get them right and Professor Octo will do a silly dance!</p>

  <div class="level-picker-label">Choose a level:</div>
  <div class="level-grid" id="startLevelGrid"></div>

  <button class="start-btn" id="startBtn">Let's Go! üöÄ</button>
</div>

<!-- Game area -->
<div class="main" id="gameArea" style="display:none;">
  <!-- Score dots -->
  <div class="score-bar" id="scoreDots"></div>

  <!-- Progress -->
  <div class="progress-wrap">
    <div class="progress-label">
      <span id="progressText">Question 1 of 10</span>
      <span id="scoreText">Score: 0</span>
    </div>
    <div class="progress-track">
      <div class="progress-fill" id="progressFill"></div>
    </div>
  </div>

  <!-- Octopus -->
  <div class="octopus-area" id="octoArea">
    <div class="speech-bubble" id="speechBubble"></div>
    <svg class="octopus-svg" viewBox="0 0 200 200" id="octoSvg">
      <!-- body -->
      <ellipse cx="100" cy="85" rx="55" ry="50" fill="#9b59b6"/>
      <ellipse cx="100" cy="85" rx="55" ry="50" fill="url(#bodyGrad2)"/>
      <ellipse cx="88" cy="72" rx="18" ry="14" fill="rgba(255,255,255,0.12)"/>
      <!-- eyes (will be swapped by JS) -->
      <g id="octoEyes">
        <ellipse cx="82" cy="82" rx="12" ry="13" fill="#fff"/>
        <ellipse cx="118" cy="82" rx="12" ry="13" fill="#fff"/>
        <circle cx="84" cy="83" r="6" fill="#2c1654" class="pupil-l"/>
        <circle cx="120" cy="83" r="6" fill="#2c1654" class="pupil-r"/>
        <circle cx="86" cy="81" r="2.2" fill="#fff"/>
        <circle cx="122" cy="81" r="2.2" fill="#fff"/>
      </g>
      <!-- mouth (will be swapped by JS) -->
      <g id="octoMouth">
        <path d="M90 100 Q100 110 110 100" stroke="#2c1654" stroke-width="2.5" fill="none" stroke-linecap="round"/>
      </g>
      <!-- tentacles -->
      <g id="octoTentacles">
        <path d="M55 120 Q40 155 55 170" stroke="#8e44ad" stroke-width="10" fill="none" stroke-linecap="round"/>
        <path d="M72 128 Q58 160 70 178" stroke="#8e44ad" stroke-width="9" fill="none" stroke-linecap="round"/>
        <path d="M90 132 Q82 165 92 180" stroke="#8e44ad" stroke-width="9" fill="none" stroke-linecap="round"/>
        <path d="M108 132 Q116 165 108 180" stroke="#8e44ad" stroke-width="9" fill="none" stroke-linecap="round"/>
        <path d="M126 128 Q140 160 130 178" stroke="#8e44ad" stroke-width="9" fill="none" stroke-linecap="round"/>
        <path d="M143 120 Q158 155 143 170" stroke="#8e44ad" stroke-width="10" fill="none" stroke-linecap="round"/>
      </g>
      <!-- spots -->
      <circle cx="70" cy="96" r="3.5" fill="rgba(255,255,255,0.15)"/>
      <circle cx="130" cy="96" r="3.5" fill="rgba(255,255,255,0.15)"/>
      <circle cx="100" cy="110" r="3" fill="rgba(255,255,255,0.12)"/>
      <!-- hat -->
      <rect x="72" y="38" width="56" height="8" rx="4" fill="#f1c40f"/>
      <rect x="82" y="12" width="36" height="30" rx="4" fill="#f1c40f"/>
      <text x="100" y="33" text-anchor="middle" font-size="14" font-weight="bold" fill="#9b59b6">‚òÖ</text>
      <defs>
        <radialGradient id="bodyGrad2" cx="40%" cy="35%">
          <stop offset="0%" stop-color="rgba(255,255,255,0.13)"/>
          <stop offset="100%" stop-color="rgba(0,0,0,0)"/>
        </radialGradient>
      </defs>
    </svg>
  </div>

  <!-- Question -->
  <div class="question-card" id="questionCard">
    <div class="level-tag" id="levelTag">Kindergarten</div>
    <div class="question-text" id="questionText">3 + 2 = ?</div>
    <div class="feedback-text" id="feedbackText"></div>
  </div>

  <!-- Answer + numpad -->
  <div class="answer-area" id="answerArea">
    <div class="answer-display" id="answerDisplay"><span class="cursor"></span></div>
    <div class="numpad" id="numpad">
      <button class="num-btn" data-val="1">1</button>
      <button class="num-btn" data-val="2">2</button>
      <button class="num-btn" data-val="3">3</button>
      <button class="num-btn" data-val="4">4</button>
      <button class="num-btn" data-val="5">5</button>
      <button class="num-btn" data-val="6">6</button>
      <button class="num-btn" data-val="7">7</button>
      <button class="num-btn" data-val="8">8</button>
      <button class="num-btn" data-val="9">9</button>
      <button class="num-btn zero" data-val="0">0</button>
      <button class="num-btn backspace" data-val="back">‚å´</button>
      <button class="num-btn submit-btn" data-val="submit">GO!</button>
    </div>
  </div>
</div>

<!-- In-game level drawer -->
<div class="level-drawer-overlay" id="levelDrawerOverlay" onclick="closeLevelDrawer(event)">
  <div class="level-drawer" onclick="event.stopPropagation()">
    <div class="drawer-handle"></div>
    <div class="drawer-title">üêô Change Level</div>
    <div class="drawer-current" id="drawerCurrent">Currently: Kindergarten</div>
    <div class="level-grid" id="drawerLevelGrid"></div>
    <div class="drawer-note">Changing level starts a fresh round</div>
  </div>
</div>

<!-- Round summary overlay -->
<div class="overlay" id="overlay">
  <div class="summary-card">
    <div class="summary-emoji" id="summaryEmoji">üéâ</div>
    <div class="summary-title" id="summaryTitle">Great Job!</div>
    <div class="summary-score" id="summaryScore">8 <span class="of">/ 10</span></div>
    <div class="summary-msg" id="summaryMsg">You're getting smarter every round!</div>
    <div class="summary-level" id="summaryLevel" style="color:var(--purple-light);font-weight:800;font-size:0.85rem;margin-bottom:0.4rem;"></div>
    <div class="summary-btns">
      <button class="summary-btn btn-primary" id="nextRoundBtn">Next Round ‚Üí</button>
      <button class="summary-btn btn-secondary" id="changeLevelBtn" onclick="openLevelFromSummary()">Change Level üéØ</button>
      <a href="#" onclick="parent.postMessage(\\'back\\',\\'*\\');return false;" class="summary-btn btn-secondary" style="text-decoration:none;text-align:center;">Back to Menu</a>
    </div>
  </div>
</div>

<script>
// ==================== GAME ENGINE ====================

const QUESTIONS_PER_ROUND = 10;

// Difficulty levels with question generators
const LEVELS = [
  {
    name: 'Kindergarten',
    generate() {
      // Addition 0-5
      const a = rand(0, 5), b = rand(0, 5);
      return { text: \`\${a} + \${b}\`, answer: a + b };
    }
  },
  {
    name: 'Grade 1 - Easy',
    generate() {
      // Addition 0-10
      const a = rand(1, 10), b = rand(1, 10);
      return { text: \`\${a} + \${b}\`, answer: a + b };
    }
  },
  {
    name: 'Grade 1',
    generate() {
      // Addition & subtraction 0-10
      if (Math.random() < 0.5) {
        const a = rand(1, 10), b = rand(1, 10);
        return { text: \`\${a} + \${b}\`, answer: a + b };
      } else {
        const b = rand(1, 8), a = rand(b, 10);
        return { text: \`\${a} ‚àí \${b}\`, answer: a - b };
      }
    }
  },
  {
    name: 'Grade 1 - Hard',
    generate() {
      // Larger addition & subtraction
      if (Math.random() < 0.5) {
        const a = rand(5, 15), b = rand(1, 10);
        return { text: \`\${a} + \${b}\`, answer: a + b };
      } else {
        const b = rand(1, 10), a = rand(b + 2, 18);
        return { text: \`\${a} ‚àí \${b}\`, answer: a - b };
      }
    }
  },
  {
    name: 'Grade 2 - Easy',
    generate() {
      // Double-digit addition/subtraction, easy multiplication
      const r = Math.random();
      if (r < 0.35) {
        const a = rand(10, 30), b = rand(1, 15);
        return { text: \`\${a} + \${b}\`, answer: a + b };
      } else if (r < 0.7) {
        const b = rand(1, 12), a = rand(b + 5, 30);
        return { text: \`\${a} ‚àí \${b}\`, answer: a - b };
      } else {
        const a = rand(1, 5), b = rand(1, 5);
        return { text: \`\${a} √ó \${b}\`, answer: a * b };
      }
    }
  },
  {
    name: 'Grade 2',
    generate() {
      const r = Math.random();
      if (r < 0.3) {
        const a = rand(10, 50), b = rand(5, 30);
        return { text: \`\${a} + \${b}\`, answer: a + b };
      } else if (r < 0.6) {
        const b = rand(5, 20), a = rand(b + 5, 50);
        return { text: \`\${a} ‚àí \${b}\`, answer: a - b };
      } else {
        const a = rand(2, 6), b = rand(2, 6);
        return { text: \`\${a} √ó \${b}\`, answer: a * b };
      }
    }
  },
  {
    name: 'Grade 2 - Hard',
    generate() {
      const r = Math.random();
      if (r < 0.25) {
        const a = rand(20, 80), b = rand(10, 50);
        return { text: \`\${a} + \${b}\`, answer: a + b };
      } else if (r < 0.5) {
        const b = rand(10, 30), a = rand(b + 10, 80);
        return { text: \`\${a} ‚àí \${b}\`, answer: a - b };
      } else if (r < 0.8) {
        const a = rand(2, 9), b = rand(2, 9);
        return { text: \`\${a} √ó \${b}\`, answer: a * b };
      } else {
        const b = rand(2, 5), ans = rand(1, 6);
        return { text: \`\${b * ans} √∑ \${b}\`, answer: ans };
      }
    }
  },
  {
    name: 'Grade 3',
    generate() {
      const r = Math.random();
      if (r < 0.2) {
        const a = rand(50, 200), b = rand(20, 150);
        return { text: \`\${a} + \${b}\`, answer: a + b };
      } else if (r < 0.4) {
        const b = rand(20, 100), a = rand(b + 20, 250);
        return { text: \`\${a} ‚àí \${b}\`, answer: a - b };
      } else if (r < 0.7) {
        const a = rand(3, 12), b = rand(3, 12);
        return { text: \`\${a} √ó \${b}\`, answer: a * b };
      } else {
        const b = rand(2, 9), ans = rand(2, 10);
        return { text: \`\${b * ans} √∑ \${b}\`, answer: ans };
      }
    }
  }
];

// State
let state = {
  round: 1,
  level: 0,          // index into LEVELS
  questionNum: 0,     // 0-based within round
  score: 0,           // correct in current round
  totalCorrect: 0,
  totalQuestions: 0,
  currentQuestion: null,
  answered: false,
  answerInput: '',
  results: [],        // per-round: true/false array
  streak: 0           // consecutive correct
};

// DOM refs
const $ = id => document.getElementById(id);
const startScreen = $('startScreen');
const gameArea = $('gameArea');
const topBar = $('topBar');
const roundBadge = $('roundBadge');
const scoreDots = $('scoreDots');
const progressFill = $('progressFill');
const progressText = $('progressText');
const scoreText = $('scoreText');
const questionCard = $('questionCard');
const levelTag = $('levelTag');
const questionText = $('questionText');
const feedbackText = $('feedbackText');
const answerDisplay = $('answerDisplay');
const answerArea = $('answerArea');
const numpad = $('numpad');
const overlay = $('overlay');
const octoArea = $('octoArea');
const speechBubble = $('speechBubble');
const octoEyes = $('octoEyes');
const octoMouth = $('octoMouth');
const levelDrawerOverlay = $('levelDrawerOverlay');
const drawerLevelGrid = $('drawerLevelGrid');
const drawerCurrent = $('drawerCurrent');
const startLevelGrid = $('startLevelGrid');

// Build level grids
function buildLevelGrid(container, onSelect) {
  container.innerHTML = '';
  LEVELS.forEach((lvl, i) => {
    const btn = document.createElement('button');
    btn.className = 'level-btn' + (i === state.level ? ' selected' : '');
    btn.dataset.level = i;
    btn.innerHTML = \`<span class="level-num">\${i + 1}</span><span class="level-name">\${lvl.name}</span>\`;
    btn.addEventListener('click', () => onSelect(i, container));
    container.appendChild(btn);
  });
}

function highlightLevel(index, container) {
  container.querySelectorAll('.level-btn').forEach((b, i) => {
    b.classList.toggle('selected', i === index);
  });
}

// Start screen level selection (just picks the level, doesn't start game)
let startSelectedLevel = 0;
function onStartLevelSelect(index, container) {
  startSelectedLevel = index;
  highlightLevel(index, container);
}

// In-game drawer level selection (switches level and restarts round)
function onDrawerLevelSelect(index, container) {
  state.level = index;
  state.round = 1;
  state.questionNum = 0;
  state.score = 0;
  state.totalCorrect = 0;
  state.totalQuestions = 0;
  state.results = [];
  state.streak = 0;
  highlightLevel(index, container);
  closeLevelDrawer();
  setOctoFace('normal');
  generateQuestion();
}

function toggleLevelDrawer() {
  if (levelDrawerOverlay.classList.contains('visible')) {
    closeLevelDrawer();
  } else {
    drawerCurrent.textContent = 'Currently: ' + LEVELS[state.level].name;
    buildLevelGrid(drawerLevelGrid, onDrawerLevelSelect);
    levelDrawerOverlay.classList.add('visible');
  }
}

function closeLevelDrawer(e) {
  if (e && e.target !== levelDrawerOverlay) return;
  levelDrawerOverlay.classList.remove('visible');
}

function openLevelFromSummary() {
  overlay.classList.remove('visible');
  drawerCurrent.textContent = 'Currently: ' + LEVELS[state.level].name;
  buildLevelGrid(drawerLevelGrid, onDrawerLevelSelect);
  levelDrawerOverlay.classList.add('visible');
}

// Initialize start screen grid
buildLevelGrid(startLevelGrid, onStartLevelSelect);

// Helpers
function rand(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

function setOctoFace(mode) {
  // mode: 'normal', 'silly', 'sad', 'thinking'
  if (mode === 'silly') {
    octoEyes.innerHTML = \`
      <ellipse cx="82" cy="82" rx="12" ry="13" fill="#fff"/>
      <ellipse cx="118" cy="82" rx="12" ry="13" fill="#fff"/>
      <circle cx="78" cy="80" r="7" fill="#2c1654"/>
      <circle cx="122" cy="86" r="7" fill="#2c1654"/>
      <circle cx="80" cy="78" r="2.5" fill="#fff"/>
      <circle cx="124" cy="84" r="2.5" fill="#fff"/>
      <ellipse cx="68" cy="72" rx="10" ry="3" fill="#e74c9c" opacity="0.4" transform="rotate(-10 68 72)"/>
      <ellipse cx="132" cy="72" rx="10" ry="3" fill="#e74c9c" opacity="0.4" transform="rotate(10 132 72)"/>
    \`;
    octoMouth.innerHTML = \`
      <ellipse cx="100" cy="104" rx="10" ry="7" fill="#2c1654"/>
      <ellipse cx="100" cy="101" rx="7" ry="3" fill="#e74c9c"/>
      <path d="M95 98 Q93 94 96 95" stroke="#2c1654" stroke-width="1" fill="none"/>
    \`;
  } else if (mode === 'sad') {
    octoEyes.innerHTML = \`
      <ellipse cx="82" cy="82" rx="12" ry="13" fill="#fff"/>
      <ellipse cx="118" cy="82" rx="12" ry="13" fill="#fff"/>
      <circle cx="84" cy="86" r="6" fill="#2c1654"/>
      <circle cx="120" cy="86" r="6" fill="#2c1654"/>
      <circle cx="86" cy="84" r="2" fill="#fff"/>
      <circle cx="122" cy="84" r="2" fill="#fff"/>
      <path d="M72 72 Q78 76 88 73" stroke="#2c1654" stroke-width="2" fill="none" stroke-linecap="round"/>
      <path d="M112 73 Q122 76 128 72" stroke="#2c1654" stroke-width="2" fill="none" stroke-linecap="round"/>
      <circle cx="75" cy="92" r="3" fill="#56d4ff" opacity="0.6"/>
    \`;
    octoMouth.innerHTML = \`
      <path d="M90 106 Q100 98 110 106" stroke="#2c1654" stroke-width="2.5" fill="none" stroke-linecap="round"/>
    \`;
  } else if (mode === 'thinking') {
    octoEyes.innerHTML = \`
      <ellipse cx="82" cy="82" rx="12" ry="13" fill="#fff"/>
      <ellipse cx="118" cy="82" rx="12" ry="13" fill="#fff"/>
      <circle cx="86" cy="80" r="6" fill="#2c1654"/>
      <circle cx="122" cy="80" r="6" fill="#2c1654"/>
      <circle cx="88" cy="78" r="2.2" fill="#fff"/>
      <circle cx="124" cy="78" r="2.2" fill="#fff"/>
    \`;
    octoMouth.innerHTML = \`
      <path d="M90 100 Q100 110 110 100" stroke="#2c1654" stroke-width="2.5" fill="none" stroke-linecap="round"/>
    \`;
  } else { // normal
    octoEyes.innerHTML = \`
      <ellipse cx="82" cy="82" rx="12" ry="13" fill="#fff"/>
      <ellipse cx="118" cy="82" rx="12" ry="13" fill="#fff"/>
      <circle cx="84" cy="83" r="6" fill="#2c1654"/>
      <circle cx="120" cy="83" r="6" fill="#2c1654"/>
      <circle cx="86" cy="81" r="2.2" fill="#fff"/>
      <circle cx="122" cy="81" r="2.2" fill="#fff"/>
    \`;
    octoMouth.innerHTML = \`
      <path d="M90 100 Q100 110 110 100" stroke="#2c1654" stroke-width="2.5" fill="none" stroke-linecap="round"/>
    \`;
  }
}

function showSpeech(text, duration = 2000) {
  speechBubble.textContent = text;
  speechBubble.classList.add('visible');
  setTimeout(() => speechBubble.classList.remove('visible'), duration);
}

const sillyPhrases = [
  'üéâ Yay!', 'ü§© Woohoo!', '‚≠ê Super!', 'ü•≥ Amazing!', 'ü¶ë Ink-credible!',
  'üêô Tenta-cool!', 'üíú Nailed it!', 'üèÜ You rock!', '‚ú® Brilliant!', 'üåü Wow!'
];
const sadPhrases = [
  'Oh, womp womp üòî', 'Womp womp! üêô', 'Oh no, womp womp!', 'Womp womp üò¢'
];

function renderScoreDots() {
  let html = '';
  for (let i = 0; i < QUESTIONS_PER_ROUND; i++) {
    let cls = '';
    if (i < state.results.length) {
      cls = state.results[i] ? 'correct-dot' : 'wrong-dot';
    } else if (i === state.questionNum) {
      cls = 'current-dot';
    }
    html += \`<div class="score-dot \${cls}"></div>\`;
  }
  scoreDots.innerHTML = html;
}

function updateUI() {
  roundBadge.textContent = \`Rd \${state.round} ¬∑ Lvl \${state.level + 1} ‚ñæ\`;
  progressText.textContent = \`Question \${state.questionNum + 1} of \${QUESTIONS_PER_ROUND}\`;
  scoreText.textContent = \`Score: \${state.score}\`;
  progressFill.style.width = ((state.questionNum) / QUESTIONS_PER_ROUND * 100) + '%';
  renderScoreDots();
}

function generateQuestion() {
  const lvl = LEVELS[Math.min(state.level, LEVELS.length - 1)];
  state.currentQuestion = lvl.generate();
  levelTag.textContent = lvl.name;
  questionText.textContent = state.currentQuestion.text + ' = ?';
  feedbackText.textContent = '';
  feedbackText.className = 'feedback-text';
  questionCard.className = 'question-card';
  state.answerInput = '';
  state.answered = false;
  answerDisplay.innerHTML = '<span class="cursor"></span>';
  showNumpad();
  setOctoFace('thinking');
  updateUI();
}

function showNumpad() {
  // Replace the next button with normal numpad
  const existingNext = numpad.querySelector('.next-btn');
  if (existingNext) existingNext.remove();
  numpad.querySelectorAll('.num-btn').forEach(b => b.style.display = '');
}

function handleInput(val) {
  if (state.answered) return;

  if (val === 'back') {
    state.answerInput = state.answerInput.slice(0, -1);
  } else if (val === 'submit') {
    if (state.answerInput === '') return;
    checkAnswer();
    return;
  } else {
    if (state.answerInput.length >= 4) return;
    // Handle leading minus? Not needed for current levels, all answers >= 0
    state.answerInput += val;
  }

  if (state.answerInput) {
    answerDisplay.innerHTML = state.answerInput + '<span class="cursor"></span>';
  } else {
    answerDisplay.innerHTML = '<span class="cursor"></span>';
  }
}

function checkAnswer() {
  const userAns = parseInt(state.answerInput, 10);
  const correct = state.currentQuestion.answer;
  state.answered = true;
  answerDisplay.innerHTML = state.answerInput;

  if (userAns === correct) {
    // Correct!
    state.score++;
    state.streak++;
    state.totalCorrect++;
    state.results.push(true);
    questionCard.classList.add('correct');
    feedbackText.textContent = \`‚úÖ Correct! \${state.currentQuestion.text} = \${correct}\`;
    feedbackText.className = 'feedback-text correct-fb';
    setOctoFace('silly');
    octoArea.classList.add('celebrate');
    showSpeech(sillyPhrases[rand(0, sillyPhrases.length - 1)]);
    setTimeout(() => octoArea.classList.remove('celebrate'), 600);
  } else {
    // Wrong
    state.streak = 0;
    state.results.push(false);
    questionCard.classList.add('wrong');
    feedbackText.textContent = \`‚ùå The answer was \${correct}\`;
    feedbackText.className = 'feedback-text wrong-fb';
    setOctoFace('sad');
    octoArea.classList.add('sad');
    showSpeech(sadPhrases[rand(0, sadPhrases.length - 1)], 2500);
    setTimeout(() => octoArea.classList.remove('sad'), 700);
  }

  state.totalQuestions++;
  renderScoreDots();
  scoreText.textContent = \`Score: \${state.score}\`;

  // Show next button
  numpad.querySelectorAll('.num-btn').forEach(b => b.style.display = 'none');
  const nextBtn = document.createElement('button');
  nextBtn.className = 'num-btn next-btn';
  nextBtn.dataset.val = 'next';
  nextBtn.textContent = state.questionNum + 1 >= QUESTIONS_PER_ROUND ? 'See Results! üéâ' : 'Next Question ‚Üí';
  numpad.appendChild(nextBtn);
}

function nextQuestion() {
  state.questionNum++;
  if (state.questionNum >= QUESTIONS_PER_ROUND) {
    endRound();
  } else {
    generateQuestion();
  }
}

function endRound() {
  // Adjust difficulty
  const pct = state.score / QUESTIONS_PER_ROUND;
  const prevLevel = state.level;
  if (pct >= 0.8 && state.level < LEVELS.length - 1) {
    state.level++;
  } else if (pct < 0.4 && state.level > 0) {
    state.level--;
  }

  // Show summary
  const emoji = pct >= 0.9 ? 'üèÜ' : pct >= 0.7 ? 'üéâ' : pct >= 0.5 ? 'üëç' : 'üí™';
  const title = pct >= 0.9 ? 'AMAZING!' : pct >= 0.7 ? 'Great Job!' : pct >= 0.5 ? 'Nice Try!' : 'Keep Going!';
  const msgs = pct >= 0.9
    ? 'You are a math superstar! üåü'
    : pct >= 0.7
    ? "You're doing awesome, keep it up!"
    : pct >= 0.5
    ? "Good effort! Practice makes perfect!"
    : "Don't give up, you'll get better!";

  // Level change message
  let levelMsg = \`Level: \${LEVELS[state.level].name}\`;
  if (state.level > prevLevel) levelMsg = \`‚¨ÜÔ∏è Level Up! ‚Üí \${LEVELS[state.level].name}\`;
  else if (state.level < prevLevel) levelMsg = \`Next: \${LEVELS[state.level].name}\`;

  $('summaryEmoji').textContent = emoji;
  $('summaryTitle').textContent = title;
  $('summaryScore').innerHTML = \`\${state.score} <span class="of">/ \${QUESTIONS_PER_ROUND}</span>\`;
  $('summaryMsg').textContent = msgs;
  $('summaryLevel').textContent = levelMsg;
  overlay.classList.add('visible');

  if (pct >= 0.8) fireConfetti();

  progressFill.style.width = '100%';
}

function startNewRound() {
  overlay.classList.remove('visible');
  state.round++;
  state.questionNum = 0;
  state.score = 0;
  state.results = [];
  setOctoFace('normal');
  generateQuestion();
}

// Confetti
function fireConfetti() {
  const canvas = $('confetti');
  const ctx = canvas.getContext('2d');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  const pieces = [];
  const colors = ['#ffe156','#ff6b9d','#56d4ff','#7cff6b','#b56bff','#ff9f43','#fff'];

  for (let i = 0; i < 120; i++) {
    pieces.push({
      x: canvas.width / 2 + (Math.random() - 0.5) * 100,
      y: canvas.height * 0.4,
      vx: (Math.random() - 0.5) * 14,
      vy: -Math.random() * 16 - 4,
      w: rand(5, 10),
      h: rand(3, 6),
      color: colors[rand(0, colors.length - 1)],
      rot: Math.random() * 360,
      rv: (Math.random() - 0.5) * 12,
      gravity: 0.35
    });
  }

  let frame = 0;
  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    let alive = false;
    pieces.forEach(p => {
      p.x += p.vx;
      p.vy += p.gravity;
      p.y += p.vy;
      p.rot += p.rv;
      if (p.y < canvas.height + 50) alive = true;
      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.rot * Math.PI / 180);
      ctx.fillStyle = p.color;
      ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
      ctx.restore();
    });
    frame++;
    if (alive && frame < 180) requestAnimationFrame(draw);
    else ctx.clearRect(0, 0, canvas.width, canvas.height);
  }
  draw();
}

// Events
$('startBtn').addEventListener('click', () => {
  state.level = startSelectedLevel;
  startScreen.style.display = 'none';
  gameArea.style.display = 'flex';
  topBar.style.display = 'flex';
  generateQuestion();
});

numpad.addEventListener('click', e => {
  const btn = e.target.closest('.num-btn');
  if (!btn) return;
  const val = btn.dataset.val;
  if (val === 'next') {
    nextQuestion();
  } else {
    handleInput(val);
  }
});

// Keyboard support (desktop)
document.addEventListener('keydown', e => {
  // Close drawer on Escape
  if (e.key === 'Escape' && levelDrawerOverlay.classList.contains('visible')) {
    levelDrawerOverlay.classList.remove('visible');
    return;
  }
  if (levelDrawerOverlay.classList.contains('visible')) return;
  if (startScreen.style.display !== 'none') return;
  if (overlay.classList.contains('visible')) {
    if (e.key === 'Enter') { startNewRound(); e.preventDefault(); }
    return;
  }
  if (state.answered) {
    if (e.key === 'Enter' || e.key === ' ') { nextQuestion(); e.preventDefault(); }
    return;
  }
  if (e.key >= '0' && e.key <= '9') handleInput(e.key);
  else if (e.key === 'Backspace') handleInput('back');
  else if (e.key === 'Enter') handleInput('submit');
});

$('nextRoundBtn').addEventListener('click', startNewRound);

// Background particles
const pCont = $('particles');
for (let i = 0; i < 20; i++) {
  const p = document.createElement('div');
  p.className = 'particle';
  const size = rand(4, 12);
  p.style.width = size + 'px';
  p.style.height = size + 'px';
  p.style.left = Math.random() * 100 + '%';
  p.style.background = ['#9b59b6','#8e44ad','#b56bff','#d4a5ff'][rand(0,3)];
  p.style.animationDuration = (8 + Math.random() * 12) + 's';
  p.style.animationDelay = (Math.random() * 10) + 's';
  pCont.appendChild(p);
}
</script>
</body>
</html>
`;
GAMES['ski'] = `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Ski & Snow!</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Lilita+One&family=Nunito:wght@600;700;800;900&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --sky-top: #4a90d9;
    --sky-bot: #a8d8ea;
    --snow-1: #f0f4f8;
    --snow-2: #dce8f0;
    --accent-blue: #3a7bd5;
    --accent-orange: #ff9f43;
    --accent-red: #ff6b6b;
    --accent-green: #2ed573;
    --card-bg: rgba(255,255,255,0.12);
    --card-border: rgba(255,255,255,0.2);
    --dark-bg: #1a1a3e;
  }

  html, body { height: 100%; overflow: hidden; }

  body {
    font-family: 'Nunito', sans-serif;
    background: var(--dark-bg);
    color: #fff;
    -webkit-tap-highlight-color: transparent;
    touch-action: none;
    overscroll-behavior: none;
  }

  /* =========== MENU SCREENS =========== */
  .screen {
    position: fixed;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 50;
    transition: opacity 0.35s, transform 0.35s;
    padding: 1.5rem;
  }
  .screen.hidden {
    opacity: 0;
    pointer-events: none;
    transform: scale(0.95);
  }

  .menu-bg {
    background: linear-gradient(170deg, #1a1040 0%, #2d1b69 40%, #1a1a4e 100%);
  }
  .game-bg {
    background: transparent;
  }

  .screen h1 {
    font-family: 'Lilita One', cursive;
    font-size: clamp(2rem, 7vw, 3rem);
    margin-bottom: 0.3rem;
    text-align: center;
  }
  .screen h1 .gradient-text {
    background: linear-gradient(135deg, #56d4ff, #fff, #a8d8ea);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .screen .subtitle {
    color: rgba(255,255,255,0.5);
    font-weight: 700;
    font-size: 0.9rem;
    margin-bottom: 1.5rem;
    text-align: center;
  }

  .choice-label {
    font-family: 'Lilita One', cursive;
    font-size: 1.1rem;
    margin-bottom: 0.8rem;
    color: rgba(255,255,255,0.7);
    letter-spacing: 1px;
  }

  .choice-row {
    display: flex;
    gap: 0.8rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    justify-content: center;
  }

  .choice-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.4rem;
    padding: 1rem 1.5rem;
    background: rgba(255,255,255,0.06);
    border: 2px solid rgba(255,255,255,0.1);
    border-radius: 1.2rem;
    color: #fff;
    font-family: 'Nunito', sans-serif;
    font-weight: 800;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.2s;
    min-width: 120px;
    -webkit-tap-highlight-color: transparent;
  }
  .choice-btn:active { transform: scale(0.95); }
  .choice-btn.selected {
    border-color: var(--accent-blue);
    background: rgba(58,123,213,0.2);
    box-shadow: 0 0 20px rgba(58,123,213,0.3);
  }
  .choice-btn .icon { font-size: 2.4rem; }

  .go-btn {
    font-family: 'Nunito', sans-serif;
    font-weight: 800;
    font-size: 1.15rem;
    padding: 0.9rem 3rem;
    background: linear-gradient(135deg, var(--accent-blue), #56d4ff);
    color: #fff;
    border: none;
    border-radius: 1.2rem;
    cursor: pointer;
    margin-top: 0.5rem;
    transition: transform 0.15s, filter 0.15s, opacity 0.3s;
    letter-spacing: 0.5px;
  }
  .go-btn:active { transform: scale(0.95); filter: brightness(1.1); }
  .go-btn:disabled { opacity: 0.3; pointer-events: none; }

  .back-link {
    position: absolute;
    top: 1rem; left: 1rem;
    display: flex; align-items: center; gap: 0.3rem;
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.12);
    color: #ccc;
    font-family: 'Nunito', sans-serif;
    font-weight: 700;
    font-size: 0.85rem;
    padding: 0.45rem 0.9rem;
    border-radius: 2rem;
    cursor: pointer;
    text-decoration: none;
    transition: background 0.2s;
    z-index: 60;
  }
  .back-link:hover { background: rgba(255,255,255,0.14); color: #fff; }

  /* Mountain decoration on menu */
  .mountain-deco {
    position: absolute;
    bottom: 0; left: 0; right: 0;
    height: 30vh;
    pointer-events: none;
    overflow: hidden;
  }
  .mountain-deco svg { width: 100%; height: 100%; }

  /* =========== GAME CANVAS =========== */
  #gameCanvas {
    position: fixed;
    top: 0; left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 1;
  }

  /* HUD */
  .hud {
    position: fixed;
    top: 0; left: 0; right: 0;
    z-index: 40;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 0.8rem 1rem;
    pointer-events: none;
  }
  .hud.hidden { display: none; }

  .hud-item {
    background: rgba(0,0,0,0.35);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    padding: 0.5rem 0.9rem;
    border-radius: 1rem;
    pointer-events: auto;
  }
  .hud-label {
    font-size: 0.6rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: rgba(255,255,255,0.5);
    font-weight: 700;
  }
  .hud-value {
    font-family: 'Lilita One', cursive;
    font-size: 1.3rem;
    color: #fff;
  }

  .hud-menu-btn {
    background: rgba(0,0,0,0.35);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    padding: 0.5rem 0.9rem;
    border-radius: 1rem;
    border: none;
    color: #ccc;
    font-family: 'Nunito', sans-serif;
    font-weight: 700;
    font-size: 0.8rem;
    cursor: pointer;
    pointer-events: auto;
  }

  /* Mobile controls */
  .mobile-controls {
    position: fixed;
    bottom: 0;
    left: 0; right: 0;
    z-index: 40;
    display: none;
    padding: 0.8rem 1rem 1.2rem;
    justify-content: space-between;
    align-items: flex-end;
    pointer-events: none;
  }
  .mobile-controls.visible { display: flex; }

  .ctrl-group {
    display: flex;
    gap: 0.5rem;
    pointer-events: auto;
  }
  .ctrl-group.vert {
    flex-direction: column;
    align-items: center;
  }
  .ctrl-group.horiz {
    flex-direction: row;
    align-items: center;
  }

  .ctrl-btn {
    width: 60px; height: 60px;
    background: rgba(255,255,255,0.12);
    border: 2px solid rgba(255,255,255,0.2);
    border-radius: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: #fff;
    cursor: pointer;
    user-select: none;
    -webkit-user-select: none;
    transition: background 0.1s;
  }
  .ctrl-btn:active, .ctrl-btn.pressed {
    background: rgba(255,255,255,0.28);
  }

  /* Crash overlay */
  .crash-overlay {
    position: fixed;
    inset: 0;
    z-index: 80;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s;
    padding: 1.5rem;
  }
  .crash-overlay.visible {
    opacity: 1;
    pointer-events: auto;
  }
  .crash-card {
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 1.4rem;
    padding: 2rem 1.5rem;
    text-align: center;
    max-width: 340px;
    width: 100%;
  }
  .crash-emoji { font-size: 3rem; margin-bottom: 0.5rem; }
  .crash-title {
    font-family: 'Lilita One', cursive;
    font-size: 1.6rem;
    margin-bottom: 0.3rem;
  }
  .crash-score { color: rgba(255,255,255,0.5); font-weight: 700; margin-bottom: 0.3rem; }
  .crash-best { color: var(--accent-orange); font-weight: 800; font-size: 0.85rem; margin-bottom: 1rem; }
  .crash-btns { display: flex; flex-direction: column; gap: 0.5rem; }
  .crash-btn {
    font-family: 'Nunito', sans-serif;
    font-weight: 800;
    font-size: 1rem;
    padding: 0.8rem;
    border: none;
    border-radius: 1rem;
    cursor: pointer;
    transition: transform 0.15s;
    text-decoration: none;
    text-align: center;
    display: block;
  }
  .crash-btn:active { transform: scale(0.96); }
  .crash-primary {
    background: linear-gradient(135deg, var(--accent-blue), #56d4ff);
    color: #fff;
  }
  .crash-secondary {
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.12);
    color: #ccc;
  }

  /* Snowflake BG for menus */
  .snowflakes {
    position: fixed;
    inset: 0;
    pointer-events: none;
    z-index: 0;
    overflow: hidden;
  }
  .snowflake {
    position: absolute;
    color: #fff;
    opacity: 0;
    animation: snowfall linear infinite;
    font-size: 1rem;
  }
  @keyframes snowfall {
    0% { transform: translateY(-5vh) translateX(0) rotate(0deg); opacity: 0; }
    10% { opacity: var(--o, 0.4); }
    90% { opacity: var(--o, 0.4); }
    100% { transform: translateY(105vh) translateX(var(--drift, 30px)) rotate(360deg); opacity: 0; }
  }
</style>
</head>
<body>

<div class="snowflakes" id="snowflakes"></div>
<canvas id="gameCanvas"></canvas>

<!-- ===== CHARACTER SELECT SCREEN ===== -->
<div class="screen menu-bg" id="selectScreen">
  <a href="#" onclick="parent.postMessage(\\'back\\',\\'*\\');return false;" class="back-link">‚Äπ Menu</a>

  <h1><span class="gradient-text">‚õ∑Ô∏è Ski & Snow!</span></h1>
  <p class="subtitle">Race down the mountain, dodge everything!</p>

  <div class="choice-label">Who are you?</div>
  <div class="choice-row" id="genderRow">
    <button class="choice-btn" data-value="girl" onclick="selectChoice('gender','girl',this)">
      <span class="icon">üëß</span> Girl
    </button>
    <button class="choice-btn" data-value="boy" onclick="selectChoice('gender','boy',this)">
      <span class="icon">üë¶</span> Boy
    </button>
  </div>

  <div class="choice-label">Pick your ride!</div>
  <div class="choice-row" id="sportRow">
    <button class="choice-btn" data-value="ski" onclick="selectChoice('sport','ski',this)">
      <span class="icon">‚õ∑Ô∏è</span> Ski
    </button>
    <button class="choice-btn" data-value="snowboard" onclick="selectChoice('sport','snowboard',this)">
      <span class="icon">üèÇ</span> Snowboard
    </button>
  </div>

  <button class="go-btn" id="goBtn" disabled onclick="startGame()">Hit the Slopes! üèîÔ∏è</button>

  <div class="mountain-deco">
    <svg viewBox="0 0 800 200" preserveAspectRatio="none">
      <polygon points="0,200 150,60 300,200" fill="rgba(255,255,255,0.04)"/>
      <polygon points="200,200 400,30 600,200" fill="rgba(255,255,255,0.06)"/>
      <polygon points="500,200 700,70 800,200" fill="rgba(255,255,255,0.04)"/>
      <polygon points="0,200 800,200 800,180 400,160 0,180" fill="rgba(255,255,255,0.03)"/>
    </svg>
  </div>
</div>

<!-- ===== HUD ===== -->
<div class="hud hidden" id="hud">
  <div class="hud-item">
    <div class="hud-label">Distance</div>
    <div class="hud-value" id="hudDist">0 m</div>
  </div>
  <div class="hud-item">
    <div class="hud-label">Speed</div>
    <div class="hud-value" id="hudSpeed">0</div>
  </div>
  <button class="hud-menu-btn" onclick="backToMenu()">‚úï</button>
</div>

<!-- ===== MOBILE CONTROLS ===== -->
<div class="mobile-controls" id="mobileControls">
  <div class="ctrl-group horiz">
    <button class="ctrl-btn" id="btnLeft" data-dir="left">‚óÄ</button>
    <button class="ctrl-btn" id="btnRight" data-dir="right">‚ñ∂</button>
  </div>
  <div class="ctrl-group vert">
    <button class="ctrl-btn" id="btnUp" data-dir="up">‚ñ≤</button>
    <button class="ctrl-btn" id="btnDown" data-dir="down">‚ñº</button>
  </div>
</div>

<!-- ===== CRASH OVERLAY ===== -->
<div class="crash-overlay" id="crashOverlay">
  <div class="crash-card">
    <div class="crash-emoji" id="crashEmoji">üí•</div>
    <div class="crash-title" id="crashTitle">Wipeout!</div>
    <div class="crash-score" id="crashScore">Distance: 0 m</div>
    <div class="crash-best" id="crashBest">Best: 0 m</div>
    <div class="crash-btns">
      <button class="crash-btn crash-primary" onclick="restartGame()">Try Again! üîÑ</button>
      <a href="#" onclick="parent.postMessage(\\'back\\',\\'*\\');return false;" class="crash-btn crash-secondary">Back to Menu</a>
    </div>
  </div>
</div>

<script>
// ==================== SETUP ====================

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

let W, H;
function resizeCanvas() {
  W = canvas.width = window.innerWidth;
  H = canvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

// Choices
let choices = { gender: null, sport: null };
let bestDistance = parseInt(localStorage.getItem('skiSnowBest') || '0', 10);

function selectChoice(type, value, btn) {
  choices[type] = value;
  const row = btn.parentElement;
  row.querySelectorAll('.choice-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  document.getElementById('goBtn').disabled = !(choices.gender && choices.sport);
}

// Detect mobile
const isMobile = ('ontouchstart' in window) || navigator.maxTouchPoints > 0;

// ==================== GAME STATE ====================

let game = null;
let animId = null;
let gameRunning = false;

const LANE_WIDTH_RATIO = 0.85;  // how much of screen width is the slope
const BASE_SPEED = 2.5;
const MAX_SPEED = 8;
const MIN_SPEED = 1.2;
const ACCEL = 0.06;
const DECEL = 0.08;
const LATERAL_SPEED = 4.5;
const PLAYER_W = 30;
const PLAYER_H = 40;
const OBSTACLE_SPAWN_INTERVAL_BASE = 45; // frames
const DIFFICULTY_RAMP = 0.0003;

// Input state
const keys = { left: false, right: false, up: false, down: false };

// ==================== OBSTACLE TYPES ====================

const OBSTACLE_DEFS = [
  { type: 'tree',    w: 34, h: 50, emoji: 'üå≤', weight: 3 },
  { type: 'tree2',   w: 30, h: 45, emoji: 'üéÑ', weight: 2 },
  { type: 'flag',    w: 18, h: 40, emoji: 'üö©', weight: 3 },
  { type: 'bear',    w: 38, h: 40, emoji: 'üêª', weight: 1 },
  { type: 'skier',   w: 28, h: 42, emoji: '‚õ∑Ô∏è', weight: 2 },
  { type: 'rock',    w: 32, h: 28, emoji: 'ü™®', weight: 2 },
  { type: 'snowman', w: 30, h: 42, emoji: '‚õÑ', weight: 1.5 },
];

function pickObstacle() {
  const totalW = OBSTACLE_DEFS.reduce((s, o) => s + o.weight, 0);
  let r = Math.random() * totalW;
  for (const o of OBSTACLE_DEFS) {
    r -= o.weight;
    if (r <= 0) return { ...o };
  }
  return { ...OBSTACLE_DEFS[0] };
}

// ==================== PARTICLE SYSTEM ====================

class Particle {
  constructor(x, y, vx, vy, life, size, color) {
    this.x = x; this.y = y;
    this.vx = vx; this.vy = vy;
    this.life = this.maxLife = life;
    this.size = size;
    this.color = color;
  }
  update() {
    this.x += this.vx;
    this.y += this.vy;
    this.life--;
  }
  draw(ctx) {
    const alpha = Math.max(0, this.life / this.maxLife);
    ctx.globalAlpha = alpha * 0.7;
    ctx.fillStyle = this.color;
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
    ctx.fill();
    ctx.globalAlpha = 1;
  }
}

// ==================== GAME INIT ====================

function initGame() {
  const slopeW = W * LANE_WIDTH_RATIO;
  const slopeL = (W - slopeW) / 2;

  game = {
    speed: BASE_SPEED,
    distance: 0,
    playerX: W / 2,
    playerY: H * 0.75,
    slopeLeft: slopeL,
    slopeRight: slopeL + slopeW,
    obstacles: [],
    spawnTimer: 0,
    spawnInterval: OBSTACLE_SPAWN_INTERVAL_BASE,
    particles: [],
    snowParticles: [],
    trailParticles: [],
    crashed: false,
    crashTimer: 0,
    frameCount: 0,
    // visual
    bgOffset: 0,
    treeLineL: [],
    treeLineR: [],
  };

  // Pre-fill snow particles
  for (let i = 0; i < 60; i++) {
    game.snowParticles.push({
      x: Math.random() * W,
      y: Math.random() * H,
      size: 1 + Math.random() * 2.5,
      speed: 0.5 + Math.random() * 1.5,
      drift: (Math.random() - 0.5) * 0.5,
      opacity: 0.3 + Math.random() * 0.5
    });
  }

  // Pre-fill decorative side trees
  for (let i = 0; i < 20; i++) {
    game.treeLineL.push({ y: Math.random() * H, size: 18 + Math.random() * 16 });
    game.treeLineR.push({ y: Math.random() * H, size: 18 + Math.random() * 16 });
  }
}

// ==================== DRAWING ====================

function drawBackground() {
  // Sky gradient
  const skyGrad = ctx.createLinearGradient(0, 0, 0, H * 0.3);
  skyGrad.addColorStop(0, '#3a7bd5');
  skyGrad.addColorStop(1, '#87CEEB');
  ctx.fillStyle = skyGrad;
  ctx.fillRect(0, 0, W, H * 0.3);

  // Distant mountains
  ctx.fillStyle = '#b8d4e8';
  ctx.beginPath();
  ctx.moveTo(0, H * 0.3);
  ctx.lineTo(W * 0.15, H * 0.12);
  ctx.lineTo(W * 0.3, H * 0.25);
  ctx.lineTo(W * 0.5, H * 0.08);
  ctx.lineTo(W * 0.7, H * 0.22);
  ctx.lineTo(W * 0.85, H * 0.1);
  ctx.lineTo(W, H * 0.28);
  ctx.lineTo(W, H * 0.3);
  ctx.fill();

  // Snow caps
  ctx.fillStyle = '#e8f1f8';
  ctx.beginPath();
  ctx.moveTo(W * 0.45, H * 0.08);
  ctx.lineTo(W * 0.5, H * 0.08);
  ctx.lineTo(W * 0.55, H * 0.13);
  ctx.lineTo(W * 0.44, H * 0.14);
  ctx.fill();

  // Snow ground
  const snowGrad = ctx.createLinearGradient(0, H * 0.25, 0, H);
  snowGrad.addColorStop(0, '#e8f1f8');
  snowGrad.addColorStop(0.3, '#f0f4f8');
  snowGrad.addColorStop(1, '#dce6ee');
  ctx.fillStyle = snowGrad;
  ctx.fillRect(0, H * 0.25, W, H * 0.75);

  // Slope track marks (moving lines)
  const offset = game.bgOffset % 40;
  ctx.strokeStyle = 'rgba(180,200,220,0.3)';
  ctx.lineWidth = 1;
  for (let y = -40 + offset; y < H; y += 40) {
    ctx.beginPath();
    ctx.moveTo(game.slopeLeft + 20, y);
    ctx.lineTo(game.slopeLeft + 25, y + 20);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(game.slopeRight - 20, y);
    ctx.lineTo(game.slopeRight - 25, y + 20);
    ctx.stroke();
  }

  // Slope edge markers
  ctx.strokeStyle = 'rgba(100,140,180,0.15)';
  ctx.lineWidth = 2;
  ctx.setLineDash([10, 15]);
  ctx.beginPath();
  ctx.moveTo(game.slopeLeft, 0);
  ctx.lineTo(game.slopeLeft, H);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(game.slopeRight, 0);
  ctx.lineTo(game.slopeRight, H);
  ctx.stroke();
  ctx.setLineDash([]);

  // Side trees
  const tOffset = game.bgOffset % (H / 4);
  ctx.font = '28px serif';
  ctx.textAlign = 'center';
  game.treeLineL.forEach(t => {
    const ty = ((t.y + tOffset) % (H + 40)) - 20;
    ctx.font = \`\${t.size}px serif\`;
    ctx.fillText('üå≤', game.slopeLeft - 20 - t.size * 0.5, ty);
  });
  game.treeLineR.forEach(t => {
    const ty = ((t.y + tOffset) % (H + 40)) - 20;
    ctx.font = \`\${t.size}px serif\`;
    ctx.fillText('üå≤', game.slopeRight + 20 + t.size * 0.5, ty);
  });
}

function drawSnow() {
  game.snowParticles.forEach(s => {
    s.y += s.speed + game.speed * 0.3;
    s.x += s.drift;
    if (s.y > H + 5) { s.y = -5; s.x = Math.random() * W; }
    if (s.x < 0) s.x = W;
    if (s.x > W) s.x = 0;
    ctx.globalAlpha = s.opacity;
    ctx.fillStyle = '#fff';
    ctx.beginPath();
    ctx.arc(s.x, s.y, s.size, 0, Math.PI * 2);
    ctx.fill();
  });
  ctx.globalAlpha = 1;
}

function drawPlayer() {
  const px = game.playerX;
  const py = game.playerY;
  const isBoard = choices.sport === 'snowboard';
  const isGirl = choices.gender === 'girl';

  // Snow spray trail
  if (!game.crashed && game.speed > 2) {
    for (let i = 0; i < 2; i++) {
      game.trailParticles.push(new Particle(
        px + (Math.random() - 0.5) * 12,
        py + PLAYER_H / 2 + Math.random() * 4,
        (Math.random() - 0.5) * 1.5,
        Math.random() * 1.5 + 0.5,
        15 + Math.random() * 10,
        1.5 + Math.random() * 2,
        '#fff'
      ));
    }
  }

  // Draw trail particles
  game.trailParticles.forEach(p => { p.update(); p.draw(ctx); });
  game.trailParticles = game.trailParticles.filter(p => p.life > 0);

  if (game.crashed) {
    // Crash: draw explosion particles + fallen character
    ctx.save();
    ctx.translate(px, py);
    ctx.rotate(Math.sin(game.crashTimer * 0.3) * 0.3 + 1.2);
    ctx.font = \`\${PLAYER_H}px serif\`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(isBoard ? 'üèÇ' : '‚õ∑Ô∏è', 0, 0);
    ctx.restore();

    // Stars
    ctx.font = '16px serif';
    for (let i = 0; i < 3; i++) {
      const angle = game.crashTimer * 0.1 + i * (Math.PI * 2 / 3);
      const sx = px + Math.cos(angle) * 25;
      const sy = py - 20 + Math.sin(angle) * 10;
      ctx.fillText('‚≠ê', sx, sy);
    }
    return;
  }

  // Tilt player based on movement
  let tilt = 0;
  if (keys.left) tilt = -0.15;
  if (keys.right) tilt = 0.15;

  ctx.save();
  ctx.translate(px, py);
  ctx.rotate(tilt);

  // Shadow
  ctx.globalAlpha = 0.15;
  ctx.fillStyle = '#000';
  ctx.beginPath();
  ctx.ellipse(2, PLAYER_H / 2 + 4, 14, 5, 0, 0, Math.PI * 2);
  ctx.fill();
  ctx.globalAlpha = 1;

  // Body
  const skinColor = isGirl ? '#f0c0a0' : '#e0b090';
  const outfitColor = isGirl ? '#e84393' : '#0984e3';
  const outfitColor2 = isGirl ? '#fd79a8' : '#74b9ff';
  const hairColor = isGirl ? '#b8860b' : '#5a3825';

  // Legs
  ctx.fillStyle = '#2d3436';
  ctx.fillRect(-8, 6, 6, 16);
  ctx.fillRect(2, 6, 6, 16);

  // Ski/board
  if (isBoard) {
    ctx.fillStyle = '#2d3436';
    ctx.beginPath();
    ctx.roundRect(-14, 20, 28, 6, 3);
    ctx.fill();
    ctx.fillStyle = outfitColor;
    ctx.beginPath();
    ctx.roundRect(-12, 21, 24, 4, 2);
    ctx.fill();
  } else {
    ctx.fillStyle = '#636e72';
    ctx.fillRect(-12, 22, 4, 2);
    ctx.fillRect(8, 22, 4, 2);
    ctx.fillStyle = outfitColor2;
    ctx.beginPath();
    ctx.roundRect(-14, 23, 8, 2, 1);
    ctx.fill();
    ctx.beginPath();
    ctx.roundRect(6, 23, 8, 2, 1);
    ctx.fill();
    // Poles
    ctx.strokeStyle = '#b0b0b0';
    ctx.lineWidth = 1.5;
    ctx.beginPath(); ctx.moveTo(-10, 0); ctx.lineTo(-18, 22); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(10, 0); ctx.lineTo(18, 22); ctx.stroke();
  }

  // Torso
  ctx.fillStyle = outfitColor;
  ctx.beginPath();
  ctx.roundRect(-10, -8, 20, 18, 4);
  ctx.fill();
  // Jacket detail
  ctx.fillStyle = outfitColor2;
  ctx.fillRect(-3, -6, 6, 14);

  // Head
  ctx.fillStyle = skinColor;
  ctx.beginPath();
  ctx.arc(0, -16, 9, 0, Math.PI * 2);
  ctx.fill();

  // Hair
  ctx.fillStyle = hairColor;
  if (isGirl) {
    ctx.beginPath();
    ctx.arc(0, -18, 9, Math.PI, Math.PI * 2);
    ctx.fill();
    // Pigtails
    ctx.beginPath(); ctx.arc(-10, -12, 4, 0, Math.PI * 2); ctx.fill();
    ctx.beginPath(); ctx.arc(10, -12, 4, 0, Math.PI * 2); ctx.fill();
  } else {
    ctx.beginPath();
    ctx.arc(0, -18, 9, Math.PI * 0.85, Math.PI * 2.15);
    ctx.fill();
  }

  // Goggles
  ctx.fillStyle = '#dfe6e9';
  ctx.beginPath();
  ctx.roundRect(-8, -19, 16, 6, 3);
  ctx.fill();
  ctx.fillStyle = 'rgba(86,212,255,0.6)';
  ctx.beginPath();
  ctx.roundRect(-7, -18, 14, 4, 2);
  ctx.fill();

  // Helmet
  ctx.fillStyle = outfitColor;
  ctx.beginPath();
  ctx.arc(0, -20, 10, Math.PI, Math.PI * 2);
  ctx.fill();

  ctx.restore();
}

function drawObstacles() {
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  game.obstacles.forEach(o => {
    // Shadow
    ctx.globalAlpha = 0.12;
    ctx.fillStyle = '#000';
    ctx.beginPath();
    ctx.ellipse(o.x + 3, o.y + o.h / 2 + 3, o.w / 2.5, 4, 0, 0, Math.PI * 2);
    ctx.fill();
    ctx.globalAlpha = 1;

    ctx.font = \`\${Math.max(o.w, o.h)}px serif\`;
    ctx.fillText(o.emoji, o.x, o.y);
  });
}

function drawCrashParticles() {
  game.particles.forEach(p => { p.update(); p.draw(ctx); });
  game.particles = game.particles.filter(p => p.life > 0);
}

// ==================== GAME LOOP ====================

function update() {
  if (game.crashed) {
    game.crashTimer++;
    if (game.crashTimer === 1) {
      // Spawn crash particles
      for (let i = 0; i < 30; i++) {
        game.particles.push(new Particle(
          game.playerX + (Math.random() - 0.5) * 20,
          game.playerY + (Math.random() - 0.5) * 20,
          (Math.random() - 0.5) * 6,
          (Math.random() - 0.5) * 6,
          30 + Math.random() * 20,
          2 + Math.random() * 4,
          ['#fff', '#dce8f0', '#b0c4de', '#ff6b6b'][Math.floor(Math.random() * 4)]
        ));
      }
    }
    if (game.crashTimer > 60) {
      showCrashScreen();
    }
    return;
  }

  // Speed
  if (keys.up) game.speed = Math.min(game.speed + ACCEL, MAX_SPEED);
  else if (keys.down) game.speed = Math.max(game.speed - DECEL, MIN_SPEED);
  else {
    // Drift towards base speed
    if (game.speed > BASE_SPEED + 0.5) game.speed -= 0.02;
    else if (game.speed < BASE_SPEED - 0.2) game.speed += 0.02;
  }

  // Lateral movement
  const latSpeed = LATERAL_SPEED * (game.speed / BASE_SPEED);
  if (keys.left) game.playerX -= latSpeed;
  if (keys.right) game.playerX += latSpeed;

  // Clamp to slope
  const halfP = PLAYER_W / 2;
  game.playerX = Math.max(game.slopeLeft + halfP, Math.min(game.slopeRight - halfP, game.playerX));

  // Distance
  game.distance += game.speed * 0.5;
  game.bgOffset += game.speed * 1.5;
  game.frameCount++;

  // Spawn obstacles
  const diffMult = 1 + game.distance * DIFFICULTY_RAMP;
  game.spawnInterval = Math.max(18, OBSTACLE_SPAWN_INTERVAL_BASE - diffMult * 3);
  game.spawnTimer++;

  if (game.spawnTimer >= game.spawnInterval) {
    game.spawnTimer = 0;
    const ob = pickObstacle();
    const margin = ob.w;
    ob.x = game.slopeLeft + margin + Math.random() * (game.slopeRight - game.slopeLeft - margin * 2);
    ob.y = -ob.h;

    // Sometimes spawn a pair
    game.obstacles.push(ob);
    if (Math.random() < 0.3 * Math.min(diffMult * 0.5, 1)) {
      const ob2 = pickObstacle();
      ob2.x = game.slopeLeft + ob2.w + Math.random() * (game.slopeRight - game.slopeLeft - ob2.w * 2);
      ob2.y = -ob2.h - Math.random() * 30;
      // Avoid overlapping the first one
      if (Math.abs(ob2.x - ob.x) > ob.w + 10) {
        game.obstacles.push(ob2);
      }
    }
  }

  // Move obstacles
  game.obstacles.forEach(o => {
    o.y += game.speed * 1.5;
  });
  game.obstacles = game.obstacles.filter(o => o.y < H + 60);

  // Collision
  const px = game.playerX;
  const py = game.playerY;
  for (const o of game.obstacles) {
    const dx = Math.abs(px - o.x);
    const dy = Math.abs(py - o.y);
    const collideX = (PLAYER_W / 2 + o.w / 2) * 0.6;
    const collideY = (PLAYER_H / 2 + o.h / 2) * 0.6;
    if (dx < collideX && dy < collideY) {
      game.crashed = true;
      game.crashTimer = 0;
      break;
    }
  }

  // Update HUD
  document.getElementById('hudDist').textContent = Math.floor(game.distance) + ' m';
  document.getElementById('hudSpeed').textContent = game.speed.toFixed(1);
}

function render() {
  ctx.clearRect(0, 0, W, H);
  drawBackground();
  drawObstacles();
  drawPlayer();
  drawSnow();
  drawCrashParticles();
}

function gameLoop() {
  if (!gameRunning) return;
  update();
  render();
  animId = requestAnimationFrame(gameLoop);
}

// ==================== GAME FLOW ====================

function startGame() {
  document.getElementById('selectScreen').classList.add('hidden');
  document.getElementById('hud').classList.remove('hidden');
  if (isMobile) document.getElementById('mobileControls').classList.add('visible');

  initGame();
  gameRunning = true;
  gameLoop();
}

function showCrashScreen() {
  gameRunning = false;
  cancelAnimationFrame(animId);

  const dist = Math.floor(game.distance);
  if (dist > bestDistance) {
    bestDistance = dist;
    localStorage.setItem('skiSnowBest', bestDistance.toString());
  }

  const crashMsgs = [
    { emoji: 'üí•', title: 'Wipeout!' },
    { emoji: 'üå®Ô∏è', title: 'Snow Crash!' },
    { emoji: 'üòµ', title: 'Ooof!' },
    { emoji: 'üêª', title: 'Watch Out!' },
  ];
  const cm = crashMsgs[Math.floor(Math.random() * crashMsgs.length)];
  document.getElementById('crashEmoji').textContent = cm.emoji;
  document.getElementById('crashTitle').textContent = cm.title;
  document.getElementById('crashScore').textContent = \`Distance: \${dist} m\`;
  document.getElementById('crashBest').textContent = \`üèÜ Best: \${bestDistance} m\`;
  document.getElementById('crashOverlay').classList.add('visible');
}

function restartGame() {
  document.getElementById('crashOverlay').classList.remove('visible');
  initGame();
  gameRunning = true;
  gameLoop();
}

function backToMenu() {
  parent.postMessage("back","*");
  gameRunning = false;
  cancelAnimationFrame(animId);
  document.getElementById('hud').classList.add('hidden');
  document.getElementById('mobileControls').classList.remove('visible');
  document.getElementById('crashOverlay').classList.remove('visible');
  document.getElementById('selectScreen').classList.remove('hidden');
  // Clear canvas
  ctx.clearRect(0, 0, W, H);
}

// ==================== INPUT ====================

// Keyboard
document.addEventListener('keydown', e => {
  if (e.key === 'ArrowLeft')  keys.left = true;
  if (e.key === 'ArrowRight') keys.right = true;
  if (e.key === 'ArrowUp')    { keys.up = true; e.preventDefault(); }
  if (e.key === 'ArrowDown')  { keys.down = true; e.preventDefault(); }
});
document.addEventListener('keyup', e => {
  if (e.key === 'ArrowLeft')  keys.left = false;
  if (e.key === 'ArrowRight') keys.right = false;
  if (e.key === 'ArrowUp')    keys.up = false;
  if (e.key === 'ArrowDown')  keys.down = false;
});

// Mobile touch buttons
function setupCtrl(id, dir) {
  const el = document.getElementById(id);
  const start = () => { keys[dir] = true; el.classList.add('pressed'); };
  const end = () => { keys[dir] = false; el.classList.remove('pressed'); };
  el.addEventListener('touchstart', e => { e.preventDefault(); start(); }, { passive: false });
  el.addEventListener('touchend', e => { e.preventDefault(); end(); }, { passive: false });
  el.addEventListener('touchcancel', end);
  el.addEventListener('mousedown', start);
  el.addEventListener('mouseup', end);
  el.addEventListener('mouseleave', end);
}
setupCtrl('btnLeft', 'left');
setupCtrl('btnRight', 'right');
setupCtrl('btnUp', 'up');
setupCtrl('btnDown', 'down');

// Prevent scroll on touch
document.addEventListener('touchmove', e => {
  if (gameRunning) e.preventDefault();
}, { passive: false });

// ==================== MENU SNOWFLAKES ====================

const sfCont = document.getElementById('snowflakes');
const sfChars = ['‚ùÑ', '‚ùÖ', '‚ùÜ', '‚Ä¢'];
for (let i = 0; i < 35; i++) {
  const s = document.createElement('div');
  s.className = 'snowflake';
  s.textContent = sfChars[Math.floor(Math.random() * sfChars.length)];
  s.style.left = Math.random() * 100 + '%';
  s.style.fontSize = (0.6 + Math.random() * 1) + 'rem';
  s.style.setProperty('--o', (0.2 + Math.random() * 0.4).toFixed(2));
  s.style.setProperty('--drift', (Math.random() - 0.5) * 60 + 'px');
  s.style.animationDuration = (5 + Math.random() * 8) + 's';
  s.style.animationDelay = (Math.random() * 8) + 's';
  sfCont.appendChild(s);
}
</script>
</body>
</html>
`;
GAMES['snowball'] = `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Snowball Fight!</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Lilita+One&family=Nunito:wght@600;700;800;900&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html, body { height: 100%; overflow: hidden; }

body {
  font-family: 'Nunito', sans-serif;
  background: #15203a;
  color: #fff;
  -webkit-tap-highlight-color: transparent;
  touch-action: none;
  overscroll-behavior: none;
  user-select: none;
  -webkit-user-select: none;
}

/* ===== SELECT SCREEN ===== */
.screen {
  position: fixed; inset: 0;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  z-index: 50; padding: 1.5rem;
  transition: opacity 0.4s, transform 0.4s;
  background: linear-gradient(160deg, #0f1a30 0%, #1b3055 45%, #162848 100%);
}
.screen.hidden { opacity: 0; pointer-events: none; transform: scale(0.94); }

.screen h1 {
  font-family: 'Lilita One', cursive;
  font-size: clamp(1.8rem, 7vw, 2.8rem);
  margin-bottom: 0.2rem; text-align: center;
}
.title-glow {
  background: linear-gradient(135deg, #ff6b6b, #fff 50%, #56d4ff);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text;
}
.subtitle {
  color: rgba(255,255,255,0.38); font-weight: 700;
  font-size: 0.82rem; margin-bottom: 1.4rem; text-align: center;
}

.pick-label {
  font-family: 'Lilita One', cursive; font-size: 1rem;
  margin-bottom: 0.6rem; color: rgba(255,255,255,0.55);
}
.pick-row {
  display: flex; gap: 0.7rem; margin-bottom: 1.4rem;
  flex-wrap: wrap; justify-content: center;
}
.pick-btn {
  display: flex; flex-direction: column; align-items: center; gap: 0.3rem;
  padding: 0.8rem 1.3rem; background: rgba(255,255,255,0.05);
  border: 2px solid rgba(255,255,255,0.1); border-radius: 1rem;
  color: #fff; font-family: 'Nunito', sans-serif; font-weight: 800;
  font-size: 0.85rem; cursor: pointer; transition: all 0.2s; min-width: 105px;
}
.pick-btn:active { transform: scale(0.95); }
.pick-btn.on {
  border-color: #56d4ff; background: rgba(86,212,255,0.14);
  box-shadow: 0 0 18px rgba(86,212,255,0.2);
}
.pick-btn .pi { font-size: 2.1rem; }

.go-btn {
  font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 1.05rem;
  padding: 0.8rem 2.4rem;
  background: linear-gradient(135deg, #e74c3c, #ff6b6b);
  color: #fff; border: none; border-radius: 1rem; cursor: pointer;
  transition: transform 0.15s, opacity 0.3s;
}
.go-btn:active { transform: scale(0.95); }
.go-btn:disabled { opacity: 0.2; pointer-events: none; }

.back-link {
  position: absolute; top: 0.8rem; left: 0.8rem;
  display: inline-flex; align-items: center; gap: 0.25rem;
  background: rgba(255,255,255,0.07); border: 1px solid rgba(255,255,255,0.1);
  color: #aaa; font-family: 'Nunito', sans-serif; font-weight: 700;
  font-size: 0.78rem; padding: 0.35rem 0.75rem; border-radius: 2rem;
  cursor: pointer; text-decoration: none; z-index: 60;
}

.hint {
  color: rgba(255,255,255,0.25); font-size: 0.65rem; font-weight: 700;
  max-width: 270px; text-align: center; margin-top: 0.8rem; line-height: 1.5;
}

/* ===== CANVAS ===== */
#gc { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; display: none; }

/* ===== HUD ===== */
.hud {
  position: fixed; top: 0; left: 0; right: 0; z-index: 40;
  display: none; justify-content: center; padding: 0.5rem; pointer-events: none;
}
.hud.on { display: flex; }
.hud-box {
  display: flex; align-items: center; gap: 0.5rem;
  background: rgba(0,0,0,0.5); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
  padding: 0.35rem 0.85rem; border-radius: 0.85rem;
  border: 1px solid rgba(255,255,255,0.07);
}
.tm { text-align: center; min-width: 42px; }
.tm-lbl { font-size: 0.48rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 800; }
.tm-lbl.b { color: #56d4ff; }
.tm-lbl.r { color: #ff6b6b; }
.tm-n { font-family: 'Lilita One', cursive; font-size: 1.25rem; line-height: 1.2; }
.vs { font-family: 'Lilita One', cursive; font-size: 0.75rem; color: rgba(255,255,255,0.25); }
.goal-lbl { font-size: 0.4rem; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 700; color: rgba(255,255,255,0.25); text-align: center; margin-top: -1px; }

.quit-btn {
  position: fixed; top: 0.5rem; left: 0.5rem; z-index: 42;
  background: rgba(0,0,0,0.4); backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
  padding: 0.32rem 0.6rem; border-radius: 0.65rem;
  border: 1px solid rgba(255,255,255,0.07);
  color: #999; font-family: 'Nunito', sans-serif; font-weight: 700;
  font-size: 0.68rem; cursor: pointer; display: none;
}
.quit-btn.on { display: block; }

/* ===== SIZE PICKER ===== */
.szp {
  position: fixed; z-index: 42; display: none; gap: 0.3rem;
}
.szp.on { display: flex; }
.szb {
  display: flex; flex-direction: column; align-items: center; gap: 0.1rem;
  padding: 0.32rem 0.5rem; background: rgba(0,0,0,0.4);
  backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
  border: 2px solid rgba(255,255,255,0.1); border-radius: 0.65rem;
  color: #999; font-family: 'Nunito', sans-serif; font-weight: 800;
  font-size: 0.52rem; cursor: pointer; text-transform: uppercase; letter-spacing: 0.5px;
}
.szb:active { transform: scale(0.94); }
.szb.on { border-color: #ffe156; color: #ffe156; background: rgba(255,225,86,0.1); }
.szd { border-radius: 50%; background: #aaa; }
.szb.on .szd { background: #ffe156; }

/* ===== MOBILE CONTROLS ===== */
.mctrls {
  position: fixed; bottom: 0; left: 0; right: 0; z-index: 42;
  display: none; padding: 0.5rem 0.8rem 0.7rem;
  justify-content: space-between; align-items: flex-end; pointer-events: none;
}
.mctrls.on { display: flex; }

.mbtn {
  pointer-events: auto;
  width: 62px; height: 62px;
  background: rgba(0,0,0,0.3); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
  border: 2px solid rgba(255,255,255,0.16); border-radius: 0.9rem;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 2px; color: #fff; cursor: pointer;
}
.mbtn:active, .mbtn.p { background: rgba(255,255,255,0.18); border-color: rgba(255,255,255,0.35); }
.mbtn .mi { font-size: 1.3rem; }
.mbtn .ml { font-size: 0.45rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.55; }
.mthrow {
  width: 72px; height: 72px; border-radius: 50%;
  background: rgba(231,76,60,0.25); border-color: rgba(231,76,60,0.4);
}
.mthrow:active { background: rgba(231,76,60,0.45); }

/* ===== TOAST ===== */
.toast {
  position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.7);
  z-index: 65; font-family: 'Lilita One', cursive;
  font-size: clamp(1rem, 4.2vw, 1.6rem);
  color: #fff; text-shadow: 0 2px 8px rgba(0,0,0,0.5);
  opacity: 0; pointer-events: none; text-align: center;
  background: rgba(0,0,0,0.5); padding: 0.45rem 1.1rem; border-radius: 0.85rem;
  backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
  transition: opacity 0.22s, transform 0.22s;
  border: 1px solid rgba(255,255,255,0.08);
}
.toast.v { opacity: 1; transform: translate(-50%, -50%) scale(1); }

/* ===== WIN OVERLAY ===== */
.wov {
  position: fixed; inset: 0; z-index: 80;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  background: rgba(0,0,0,0.7); backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
  opacity: 0; pointer-events: none; transition: opacity 0.4s; padding: 1.5rem;
}
.wov.v { opacity: 1; pointer-events: auto; }
.wcard {
  background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1);
  border-radius: 1.2rem; padding: 1.6rem 1.2rem; text-align: center;
  max-width: 310px; width: 100%;
}
.we { font-size: 3rem; margin-bottom: 0.3rem; }
.wt { font-family: 'Lilita One', cursive; font-size: 1.6rem; margin-bottom: 0.15rem; }
.ws { color: rgba(255,255,255,0.4); font-weight: 700; font-size: 0.82rem; margin-bottom: 0.3rem; }
.wf { font-family: 'Lilita One', cursive; font-size: 1.7rem; margin-bottom: 0.8rem; }
.wbtns { display: flex; flex-direction: column; gap: 0.4rem; }
.wb {
  font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 0.9rem;
  padding: 0.7rem; border: none; border-radius: 0.85rem; cursor: pointer;
  text-decoration: none; text-align: center; display: block;
}
.wb:active { transform: scale(0.96); }
.wb1 { background: linear-gradient(135deg, #e74c3c, #ff6b6b); color: #fff; }
.wb2 { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.09); color: #999; }

/* Menu snow deco */
.sdeco { position: fixed; inset: 0; pointer-events: none; z-index: 0; overflow: hidden; }
.sf {
  position: absolute; color: #fff; opacity: 0;
  animation: sfl linear infinite;
}
@keyframes sfl {
  0% { transform: translateY(-5vh) translateX(0) rotate(0); opacity: 0; }
  8% { opacity: var(--o,0.3); } 92% { opacity: var(--o,0.3); }
  100% { transform: translateY(105vh) translateX(var(--d,20px)) rotate(360deg); opacity: 0; }
}
</style>
</head>
<body>

<div class="sdeco" id="sdeco"></div>
<canvas id="gc"></canvas>

<!-- ===== SELECT SCREEN ===== -->
<div class="screen" id="selScreen">
  <a href="#" onclick="parent.postMessage(\\'back\\',\\'*\\');return false;" class="back-link">‚Äπ Menu</a>
  <h1><span class="title-glow">‚ùÑÔ∏è Snowball Fight!</span></h1>
  <p class="subtitle">4 vs 4, first to 13 wins!</p>

  <div class="pick-label">Who are you?</div>
  <div class="pick-row" id="gRow">
    <button class="pick-btn" onclick="pickG('girl',this)"><span class="pi">üëß</span>Girl</button>
    <button class="pick-btn" onclick="pickG('boy',this)"><span class="pi">üë¶</span>Boy</button>
  </div>

  <button class="go-btn" id="goBtn" disabled onclick="startGame()">Start the Fight! ‚ùÑÔ∏è</button>
  <p class="hint" id="hint"></p>
</div>

<!-- ===== HUD ===== -->
<div class="hud" id="hud">
  <div style="display:flex;flex-direction:column;align-items:center;">
    <div class="hud-box">
      <div class="tm"><div class="tm-lbl b">Your Team</div><div class="tm-n" id="sB">0</div></div>
      <div class="vs">vs</div>
      <div class="tm"><div class="tm-lbl r">Them</div><div class="tm-n" id="sR">0</div></div>
    </div>
    <div class="goal-lbl">First to 13</div>
  </div>
</div>
<button class="quit-btn" id="qBtn" onclick="quit()">‚úï Quit</button>

<!-- Size picker -->
<div class="szp" id="szp">
  <button class="szb on" data-s="small" onclick="pickSz('small',this)"><div class="szd" style="width:8px;height:8px"></div>S</button>
  <button class="szb" data-s="medium" onclick="pickSz('medium',this)"><div class="szd" style="width:12px;height:12px"></div>M</button>
  <button class="szb" data-s="large" onclick="pickSz('large',this)"><div class="szd" style="width:16px;height:16px"></div>L</button>
</div>

<!-- ===== MOBILE ===== -->
<div class="mctrls" id="mc">
  <div class="mbtn" id="bDuck"><span class="mi">‚¨áÔ∏è</span><span class="ml">Duck</span></div>
  <div class="mbtn mthrow" id="bThrow"><span class="mi">üéØ</span><span class="ml">Throw</span></div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Win overlay -->
<div class="wov" id="wov">
  <div class="wcard">
    <div class="we" id="wE">üèÜ</div>
    <div class="wt" id="wT">You Win!</div>
    <div class="ws" id="wS">Your team crushed it!</div>
    <div class="wf" id="wF">13 - 8</div>
    <div class="wbtns">
      <button class="wb wb1" onclick="replay()">Play Again! üîÑ</button>
      <a href="#" onclick="parent.postMessage(\\'back\\',\\'*\\');return false;" class="wb wb2">Back to Menu</a>
    </div>
  </div>
</div>

<script>
// ==================== ENGINE ====================
const cv = document.getElementById('gc');
const cx = cv.getContext('2d');
let W, H;
const TOUCH = ('ontouchstart' in window) || navigator.maxTouchPoints > 0;

function resize() {
  W = cv.width = window.innerWidth;
  H = cv.height = window.innerHeight;
  if (G) calcZones();
}
resize();
window.addEventListener('resize', resize);

// Controls hint
document.getElementById('hint').textContent = TOUCH
  ? 'Hold ‚¨áÔ∏è to duck behind the snow bank. Tap üéØ to throw!'
  : '‚¨á Arrow = duck, Space / ‚¨Ü = throw, 1/2/3 = change size';

// ==================== CONFIG ====================
const GOAL = 13;
const TEAM = 4;
const KW = 28, KH = 46;
const SZ = {
  small:  { r: 4,  sp: 4 },
  medium: { r: 7,  sp: 3 },
  large:  { r: 11, sp: 2.2 }
};

let gender = null;
let running = false;
let loopId = null;
let G = null;

// ==================== MENU ====================
function pickG(g, btn) {
  gender = g;
  document.querySelectorAll('#gRow .pick-btn').forEach(b => b.classList.remove('on'));
  btn.classList.add('on');
  document.getElementById('goBtn').disabled = false;
}
function pickSz(s, btn) {
  if (G) G.bsz = s;
  document.querySelectorAll('.szb').forEach(b => b.classList.remove('on'));
  btn.classList.add('on');
}

// ==================== ZONES ====================
// Scene layout top-to-bottom:
// sky ‚Üí enemy yard ‚Üí top snowbank ‚Üí road ‚Üí bottom snowbank ‚Üí player yard ‚Üí ground
let Z = {};

function calcZones() {
  const skyH = H * 0.12;
  const yardH = H * 0.14;
  const bankH = H * 0.13;  // Taller walls
  const roadH = H * 0.18;

  Z = {
    skyH,
    eYardTop: skyH, eYardH: yardH,
    tBankY: skyH + yardH,
    bankH,
    roadY: skyH + yardH + bankH,
    roadH,
    bBankY: skyH + yardH + bankH + roadH,
    pYardTop: skyH + yardH + bankH + roadH + bankH,
    pYardH: yardH,
    groundY: skyH + yardH + bankH + roadH + bankH + yardH
  };

  if (!G) return;
  const mg = 36;
  const sp = (W - mg * 2) / TEAM;
  for (let i = 0; i < TEAM; i++) {
    const xp = mg + sp * (i + 0.5);
    G.pt[i].x = xp;
    G.et[i].x = xp;
    // Position kids so head+shoulders peek above wall top, legs hidden behind wall
    G.et[i].by = Z.tBankY + 14;   // enemies behind top wall
    G.pt[i].by = Z.bBankY + 14;   // players behind bottom wall
  }
}

// ==================== INIT ====================
function mkKid(i, isMe, isEnemy, g, col) {
  return {
    x: 0, by: 0,
    duck: false, duckT: 0,
    isMe,
    hit: false, hitT: 0,
    cd: isEnemy ? 120 + Math.random() * 300 : (isMe ? 0 : 100 + Math.random() * 250),
    g, col,
    throwA: 0
  };
}

function initGame() {
  const pCol = [
    { c: '#3498db', c2: '#6ab5e6', h: '#2471a3', sc: '#f1c40f' },
    { c: '#f1c40f', c2: '#f7dc6f', h: '#d4ac0d', sc: '#e74c3c' },  // Player: BRIGHT GOLD
    { c: '#8e44ad', c2: '#b88fce', h: '#6c3483', sc: '#f39c12' },
    { c: '#1abc9c', c2: '#73d5c4', h: '#148f77', sc: '#e74c3c' }
  ];
  const eCol = [
    { c: '#e74c3c', c2: '#f1948a', h: '#b03a2e', sc: '#2ecc71' },
    { c: '#e67e22', c2: '#f0b27a', h: '#ca6f1e', sc: '#3498db' },
    { c: '#c0392b', c2: '#e56b6f', h: '#922b21', sc: '#f1c40f' },
    { c: '#d4ac0d', c2: '#f7dc6f', h: '#b7950b', sc: '#8e44ad' }
  ];

  const pt = [], et = [];
  for (let i = 0; i < TEAM; i++) {
    const pg = i === 1 ? gender : (Math.random() < 0.5 ? 'boy' : 'girl');
    pt.push(mkKid(i, i === 1, false, pg, pCol[i]));
    et.push(mkKid(i, false, true, Math.random() < 0.5 ? 'boy' : 'girl', eCol[i]));
  }

  G = {
    pt, et,
    ps: 0, es: 0,
    balls: [], vehs: [], parts: [], flakes: [],
    bsz: 'small',
    vTmr: 120 + Math.random() * 180,
    fr: 0,
    pDuck: false,
    won: false
  };

  for (let i = 0; i < 55; i++) {
    G.flakes.push({
      x: Math.random() * W, y: Math.random() * H,
      sz: 1 + Math.random() * 2.5, sp: 0.3 + Math.random() * 0.8,
      dr: (Math.random() - 0.5) * 0.3, op: 0.2 + Math.random() * 0.35
    });
  }

  calcZones();
}

// ==================== DRAWING ====================

function rr(x, y, w, h, r) {
  cx.beginPath();
  cx.moveTo(x + r, y);
  cx.lineTo(x + w - r, y); cx.quadraticCurveTo(x + w, y, x + w, y + r);
  cx.lineTo(x + w, y + h - r); cx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
  cx.lineTo(x + r, y + h); cx.quadraticCurveTo(x, y + h, x, y + h - r);
  cx.lineTo(x, y + r); cx.quadraticCurveTo(x, y, x + r, y);
  cx.fill();
}

function drawBank(y, h, c1, c2, isFront) {
  // === VERTICAL SNOW WALL (seen from side) ===

  // Wall face - gradient gives depth illusion
  const wg = cx.createLinearGradient(0, y, 0, y + h);
  wg.addColorStop(0, '#e8f0f6');
  wg.addColorStop(0.15, c1);
  wg.addColorStop(0.7, c2);
  wg.addColorStop(1, '#b8c8d6');
  cx.fillStyle = wg;
  cx.fillRect(0, y, W, h);

  // Horizontal snow block lines (like stacked packed snow)
  cx.strokeStyle = 'rgba(180,200,218,0.35)';
  cx.lineWidth = 1;
  const blockH = h / 4;
  for (let row = 1; row < 4; row++) {
    const ly = y + row * blockH;
    cx.beginPath(); cx.moveTo(0, ly); cx.lineTo(W, ly); cx.stroke();
  }

  // Vertical mortar lines staggered per row
  cx.strokeStyle = 'rgba(180,200,218,0.2)';
  for (let row = 0; row < 4; row++) {
    const rowY = y + row * blockH;
    const offset = (row % 2) * 30;
    for (let bx = offset; bx < W; bx += 60) {
      cx.beginPath(); cx.moveTo(bx, rowY); cx.lineTo(bx, rowY + blockH); cx.stroke();
    }
  }

  // Snow-covered flat top edge with bumps
  const topH = 6;
  cx.fillStyle = '#f0f6fa';
  cx.beginPath(); cx.moveTo(0, y + topH);
  for (let xp = 0; xp <= W; xp += 10) {
    cx.lineTo(xp, y - 2 - Math.sin(xp * 0.07 + y * 0.01) * 3 - Math.cos(xp * 0.12) * 2);
  }
  cx.lineTo(W, y + topH); cx.closePath(); cx.fill();

  // Top highlight line
  cx.strokeStyle = 'rgba(255,255,255,0.5)';
  cx.lineWidth = 1.5;
  cx.beginPath();
  for (let xp = 0; xp <= W; xp += 10) {
    const bumpY = y - 1 - Math.sin(xp * 0.07 + y * 0.01) * 3 - Math.cos(xp * 0.12) * 2;
    if (xp === 0) cx.moveTo(xp, bumpY); else cx.lineTo(xp, bumpY);
  }
  cx.stroke();

  // Bottom shadow for 3D depth
  cx.fillStyle = 'rgba(0,0,0,0.06)';
  cx.fillRect(0, y + h - 3, W, 3);

  // Front wall gets a subtle inner shadow at the top
  if (isFront) {
    const shg = cx.createLinearGradient(0, y, 0, y + 12);
    shg.addColorStop(0, 'rgba(0,0,0,0.05)');
    shg.addColorStop(1, 'rgba(0,0,0,0)');
    cx.fillStyle = shg;
    cx.fillRect(0, y, W, 12);
  }
}

function drawPlayerIndicator(kid) {
  if (!kid.isMe) return;
  const { x, duck } = kid;

  // Pulsing glow circle
  const glowPulse = 0.35 + Math.sin(G.fr * 0.06) * 0.15;
  const glowR = 30 + Math.sin(G.fr * 0.05) * 5;
  const gy = kid.by + (duck ? KH * 0.15 : -KH * 0.15);
  cx.save();
  cx.globalAlpha = glowPulse;
  const glowG = cx.createRadialGradient(x, gy, 0, x, gy, glowR);
  glowG.addColorStop(0, 'rgba(255,225,86,0.6)');
  glowG.addColorStop(0.5, 'rgba(255,225,86,0.2)');
  glowG.addColorStop(1, 'rgba(255,225,86,0)');
  cx.fillStyle = glowG;
  cx.beginPath(); cx.arc(x, gy, glowR, 0, Math.PI * 2); cx.fill();
  cx.globalAlpha = 1;
  cx.restore();

  // Ground spotlight
  cx.save();
  cx.globalAlpha = 0.2 + Math.sin(G.fr * 0.06) * 0.05;
  cx.fillStyle = '#ffe156';
  cx.beginPath(); cx.ellipse(x, kid.by + KH * 0.5, 20, 6, 0, 0, Math.PI * 2); cx.fill();
  cx.globalAlpha = 1;
  cx.restore();

  // Floating "YOU" arrow - big, always visible, even when ducking
  const arrowBaseY = duck ? kid.by - 8 : kid.by - KH - 14;
  const ay = arrowBaseY + Math.sin(G.fr * 0.07) * 5;
  cx.save(); cx.translate(x, ay);
  // Arrow shadow
  cx.globalAlpha = 0.25;
  cx.fillStyle = '#000';
  cx.beginPath();
  cx.moveTo(0, 16); cx.lineTo(-10, 3); cx.lineTo(-4, 3);
  cx.lineTo(-4, -10); cx.lineTo(4, -10); cx.lineTo(4, 3);
  cx.lineTo(10, 3); cx.closePath(); cx.fill();
  cx.globalAlpha = 1;
  // Arrow body with pulsing color
  const arrowBright = 0.85 + Math.sin(G.fr * 0.1) * 0.15;
  cx.fillStyle = \`rgba(255,225,86,\${arrowBright})\`;
  cx.beginPath();
  cx.moveTo(0, 14); cx.lineTo(-9, 2); cx.lineTo(-4, 2);
  cx.lineTo(-4, -10); cx.lineTo(4, -10); cx.lineTo(4, 2);
  cx.lineTo(9, 2); cx.closePath(); cx.fill();
  // Arrow white highlight
  cx.fillStyle = 'rgba(255,255,255,0.4)';
  cx.fillRect(-2, -8, 4, 8);
  // "YOU" label with dark pill background
  cx.fillStyle = 'rgba(0,0,0,0.55)';
  rr(-18, -27, 36, 15, 6);
  cx.fillStyle = '#ffe156';
  cx.font = '900 11px Nunito, sans-serif'; cx.textAlign = 'center';
  cx.fillText('YOU', 0, -15);
  cx.restore();
}

function drawScene() {
  // Sky
  const sg = cx.createLinearGradient(0, 0, 0, Z.skyH);
  sg.addColorStop(0, '#6a9fd6'); sg.addColorStop(1, '#a6c8e2');
  cx.fillStyle = sg; cx.fillRect(0, 0, W, Z.skyH + 5);

  // Cloud puffs
  cx.fillStyle = 'rgba(255,255,255,0.25)';
  [[W*0.15, Z.skyH*0.3, 35], [W*0.55, Z.skyH*0.22, 28], [W*0.82, Z.skyH*0.38, 22]].forEach(([cx2,cy,r]) => {
    cx.beginPath(); cx.arc(cx2, cy, r, 0, Math.PI*2); cx.fill();
    cx.beginPath(); cx.arc(cx2-r*0.7, cy+4, r*0.7, 0, Math.PI*2); cx.fill();
    cx.beginPath(); cx.arc(cx2+r*0.8, cy+3, r*0.65, 0, Math.PI*2); cx.fill();
  });

  // Distant trees
  for (let xp = 0; xp < W; xp += 26) {
    const th = 15 + Math.sin(xp * 0.055) * 9;
    const ty = Z.skyH - th;
    // Tree body
    cx.fillStyle = '#6a9960';
    cx.beginPath(); cx.moveTo(xp, ty + th + 2); cx.lineTo(xp + 6, ty); cx.lineTo(xp + 12, ty + th + 2); cx.fill();
    // Snow cap
    cx.fillStyle = '#e4f0f6';
    cx.beginPath(); cx.moveTo(xp + 1, ty + 5); cx.lineTo(xp + 6, ty - 2); cx.lineTo(xp + 11, ty + 5); cx.fill();
  }

  // Enemy yard
  const ey = cx.createLinearGradient(0, Z.eYardTop, 0, Z.tBankY);
  ey.addColorStop(0, '#d8e8f2'); ey.addColorStop(1, '#cee0ec');
  cx.fillStyle = ey; cx.fillRect(0, Z.eYardTop, W, Z.eYardH);

  // Top snowbank (enemy wall)
  drawBank(Z.tBankY, Z.bankH, '#e2edf6', '#d6e4f0', false);

  // Road
  cx.fillStyle = '#505358';
  cx.fillRect(0, Z.roadY, W, Z.roadH);
  // Road lines
  cx.strokeStyle = '#bbb'; cx.lineWidth = 2;
  cx.setLineDash([18, 14]);
  cx.beginPath();
  cx.moveTo(0, Z.roadY + Z.roadH / 2);
  cx.lineTo(W, Z.roadY + Z.roadH / 2);
  cx.stroke();
  cx.setLineDash([]);
  // Curbs
  cx.fillStyle = '#7a7a7a';
  cx.fillRect(0, Z.roadY, W, 3);
  cx.fillRect(0, Z.roadY + Z.roadH - 3, W, 3);

  // Bottom snowbank (player wall)
  drawBank(Z.bBankY, Z.bankH, '#dee9f3', '#d0e0ee', true);

  // Player yard
  const py = cx.createLinearGradient(0, Z.pYardTop, 0, Z.groundY);
  py.addColorStop(0, '#d6e4f0'); py.addColorStop(1, '#c8dae6');
  cx.fillStyle = py; cx.fillRect(0, Z.pYardTop, W, Z.pYardH);

  // Ground
  cx.fillStyle = '#c2d4e2';
  cx.fillRect(0, Z.groundY, W, H - Z.groundY);
}

function drawKid(kid, up) {
  const { x, duck, hit, hitT, col, g: gk, isMe, throwA } = kid;
  const dOff = duck ? KH * 0.52 : 0;
  const ky = kid.by + dOff;

  cx.save();
  cx.translate(x, ky);
  if (hit && hitT > 0) cx.rotate(Math.sin(hitT * 0.7) * 0.13);

  const skin = gk === 'girl' ? '#f5ccaa' : '#e8be9a';
  const hair = gk === 'girl' ? '#6b3a1e' : '#3d2512';

  // Shadow
  cx.globalAlpha = 0.07;
  cx.fillStyle = '#000';
  cx.beginPath(); cx.ellipse(0, KH * 0.46, 10, 3, 0, 0, Math.PI * 2); cx.fill();
  cx.globalAlpha = 1;

  if (!duck) {
    // Legs
    cx.fillStyle = '#3e5060';
    cx.fillRect(-6, 6, 5, 13); cx.fillRect(1, 6, 5, 13);
    // Boots
    cx.fillStyle = '#2c3545';
    rr(-7, 17, 6, 5, 2); rr(1, 17, 6, 5, 2);
  }

  // Torso
  cx.fillStyle = col.c;
  rr(-9, -8, 18, duck ? 11 : 16, 3);
  cx.fillStyle = col.c2;
  cx.fillRect(-2, -6, 4, duck ? 8 : 12);

  if (!duck) {
    const aRaise = throwA > 0 ? -throwA * 0.16 : 0;
    cx.fillStyle = col.c;
    cx.fillRect(-13, -4 + aRaise, 5, 9);
    cx.fillRect(8, -4 + aRaise, 5, 9);
    cx.fillStyle = '#2c3545';
    cx.fillRect(-13, 4 + aRaise, 5, 3);
    cx.fillRect(8, 4 + aRaise, 5, 3);
  }

  // Scarf
  cx.fillStyle = col.sc;
  cx.fillRect(-7, -9, 14, 3);
  if (!duck) { cx.fillRect(-9, -8, 3, 6); }

  // Head
  cx.fillStyle = skin;
  cx.beginPath(); cx.arc(0, -16, 7.5, 0, Math.PI * 2); cx.fill();

  // Hair
  cx.fillStyle = hair;
  if (gk === 'girl') {
    cx.beginPath(); cx.arc(0, -18, 7.5, Math.PI * 0.9, Math.PI * 2.1); cx.fill();
    cx.beginPath(); cx.arc(-8, -12, 2.5, 0, Math.PI * 2); cx.fill();
    cx.beginPath(); cx.arc(8, -12, 2.5, 0, Math.PI * 2); cx.fill();
  } else {
    cx.beginPath(); cx.arc(0, -18, 7.5, Math.PI * 0.8, Math.PI * 2.2); cx.fill();
  }

  // Hat
  cx.fillStyle = col.h;
  cx.beginPath(); cx.arc(0, -20, 8.5, Math.PI, Math.PI * 2); cx.fill();
  cx.fillRect(-8.5, -20, 17, 3);
  cx.fillStyle = '#fff';
  cx.beginPath(); cx.arc(0, -27, 3, 0, Math.PI * 2); cx.fill();

  // Eyes
  const eY = up ? -18 : -14;
  cx.fillStyle = '#1a1a2e';
  cx.beginPath(); cx.arc(-3, eY, 1.5, 0, Math.PI * 2); cx.fill();
  cx.beginPath(); cx.arc(3, eY, 1.5, 0, Math.PI * 2); cx.fill();
  // Smile
  cx.strokeStyle = '#1a1a2e'; cx.lineWidth = 1;
  cx.beginPath(); cx.arc(0, up ? -14 : -12, 3, 0.15 * Math.PI, 0.85 * Math.PI); cx.stroke();
  // Cheeks
  cx.fillStyle = 'rgba(228,90,90,0.22)';
  cx.beginPath(); cx.arc(-6, -14, 2.5, 0, Math.PI * 2); cx.fill();
  cx.beginPath(); cx.arc(6, -14, 2.5, 0, Math.PI * 2); cx.fill();

  // Hit stars
  if (hit && hitT > 0) {
    cx.font = '10px serif'; cx.textAlign = 'center';
    for (let i = 0; i < 3; i++) {
      const a = hitT * 0.15 + i * 2.1;
      cx.fillText('‚≠ê', Math.cos(a) * 14, -30 + Math.sin(a) * 5);
    }
  }

  cx.restore();
}

function drawVeh(v) {
  cx.save(); cx.translate(v.x, v.y);

  if (v.tp === 'plow') {
    cx.fillStyle = '#e88620';
    rr(-v.w / 2, -v.h / 2, v.w, v.h, 5);
    cx.fillStyle = '#cc6a10';
    rr(-v.w / 2 + 3, -v.h / 2 + 2, v.w * 0.32, v.h - 4, 3);
    cx.fillStyle = '#a8d4f0';
    rr(-v.w / 2 + 5, -v.h / 2 + 4, v.w * 0.22, v.h * 0.4, 2);
    // Plow blade
    const pd = v.sp > 0 ? 1 : -1;
    cx.fillStyle = '#f5a623';
    cx.beginPath();
    cx.moveTo(pd * v.w / 2, -v.h / 2 - 2);
    cx.lineTo(pd * (v.w / 2 + 15), -v.h / 2 + 5);
    cx.lineTo(pd * (v.w / 2 + 15), v.h / 2 - 3);
    cx.lineTo(pd * v.w / 2, v.h / 2 + 2);
    cx.fill();
    // Snow spray from plow
    cx.fillStyle = 'rgba(220,235,248,0.6)';
    for (let i = 0; i < 5; i++) {
      const sx = pd * (v.w / 2 + 12 + Math.random() * 15);
      const sy = -v.h / 2 + Math.random() * v.h;
      cx.beginPath(); cx.arc(sx, sy, 2 + Math.random() * 3, 0, Math.PI * 2); cx.fill();
    }
    // Wheels
    cx.fillStyle = '#222';
    cx.beginPath(); cx.arc(-v.w / 4, v.h / 2, 5, 0, Math.PI * 2); cx.fill();
    cx.beginPath(); cx.arc(v.w / 4, v.h / 2, 5, 0, Math.PI * 2); cx.fill();
    // Warning light
    if (G.fr % 16 < 8) {
      cx.fillStyle = 'rgba(255,200,0,0.85)';
      cx.beginPath(); cx.arc(0, -v.h / 2 - 4, 4, 0, Math.PI * 2); cx.fill();
    }
  } else {
    cx.fillStyle = v.cl;
    rr(-v.w / 2, -v.h / 2, v.w, v.h, 4);
    cx.fillStyle = v.cl2;
    rr(-v.w * 0.22, -v.h / 2 + 1, v.w * 0.44, v.h - 2, 3);
    cx.fillStyle = '#a8d4f0';
    rr(-v.w * 0.18, -v.h / 2 + 3, v.w * 0.36, v.h * 0.36, 2);
    cx.fillStyle = '#222';
    cx.beginPath(); cx.arc(-v.w / 3, v.h / 2, 3.5, 0, Math.PI * 2); cx.fill();
    cx.beginPath(); cx.arc(v.w / 3, v.h / 2, 3.5, 0, Math.PI * 2); cx.fill();
    // Headlight
    const hd = v.sp > 0 ? 1 : -1;
    cx.fillStyle = 'rgba(255,240,180,0.5)';
    cx.beginPath(); cx.arc(hd * v.w / 2.2, -v.h * 0.15, 2, 0, Math.PI * 2); cx.fill();
    cx.beginPath(); cx.arc(hd * v.w / 2.2, v.h * 0.15, 2, 0, Math.PI * 2); cx.fill();
  }

  cx.restore();
}

function drawBall(b) {
  cx.save(); cx.translate(b.x, b.y);
  cx.globalAlpha = 0.1; cx.fillStyle = '#000';
  cx.beginPath(); cx.ellipse(1.5, 1.5, b.r, b.r * 0.4, 0, 0, Math.PI * 2); cx.fill();
  cx.globalAlpha = 1;
  const g = cx.createRadialGradient(-b.r * 0.3, -b.r * 0.3, 0, 0, 0, b.r);
  g.addColorStop(0, '#fff'); g.addColorStop(1, '#c6d8e6');
  cx.fillStyle = g;
  cx.beginPath(); cx.arc(0, 0, b.r, 0, Math.PI * 2); cx.fill();
  cx.restore();
}

function drawPile() {
  const me = G.pt.find(k => k.isMe);
  if (!me) return;
  const px = me.x + 24, py = Z.bBankY - 2;
  cx.fillStyle = '#ced8e4';
  cx.beginPath(); cx.ellipse(px, py + 5, 13, 5.5, 0, 0, Math.PI * 2); cx.fill();
  [[-4,0,4],[ 4,0,4],[0,0.5,4],[-2,-5,3.5],[3,-5,3.5],[0.5,-9,3]].forEach(([dx,dy,r]) => {
    const g = cx.createRadialGradient(px+dx-0.8,py+dy-0.8,0,px+dx,py+dy,r);
    g.addColorStop(0,'#fff'); g.addColorStop(1,'#c6d8e6');
    cx.fillStyle = g;
    cx.beginPath(); cx.arc(px+dx, py+dy, r, 0, Math.PI*2); cx.fill();
  });
  cx.fillStyle = 'rgba(0,0,0,0.18)'; cx.font = '700 7px Nunito,sans-serif'; cx.textAlign = 'center';
  cx.fillText('‚àû', px, py + 14);
}

function drawFlakes() {
  G.flakes.forEach(f => {
    f.y += f.sp; f.x += f.dr;
    if (f.y > H + 5) { f.y = -5; f.x = Math.random() * W; }
    if (f.x < 0) f.x = W; if (f.x > W) f.x = 0;
    cx.globalAlpha = f.op; cx.fillStyle = '#fff';
    cx.beginPath(); cx.arc(f.x, f.y, f.sz, 0, Math.PI * 2); cx.fill();
  });
  cx.globalAlpha = 1;
}

function drawParts() {
  G.parts = G.parts.filter(p => {
    p.x += p.vx; p.y += p.vy; p.vy += 0.15; p.l--;
    if (p.l <= 0) return false;
    cx.globalAlpha = p.l / p.ml * 0.8;
    cx.fillStyle = p.c;
    cx.beginPath(); cx.arc(p.x, p.y, p.s, 0, Math.PI * 2); cx.fill();
    cx.globalAlpha = 1;
    return true;
  });
}

function burst(x, y, n, c) {
  for (let i = 0; i < n; i++) {
    G.parts.push({
      x, y, vx: (Math.random()-0.5)*5, vy: (Math.random()-0.5)*5-2,
      l: 13+Math.random()*13, ml: 26, s: 1.5+Math.random()*3, c: c||'#fff'
    });
  }
}

// ==================== LOGIC ====================

let tTO = null;
function toast(t, d) {
  const el = document.getElementById('toast');
  el.textContent = t; el.classList.add('v');
  clearTimeout(tTO);
  tTO = setTimeout(() => el.classList.remove('v'), d || 1200);
}

function playerThrow() {
  if (!G || G.won) return;
  const me = G.pt.find(k => k.isMe);
  if (!me || me.duck || me.cd > 0) return;

  const sz = SZ[G.bsz];
  // target a non-ducking enemy, or random
  let tgts = G.et.filter(e => !e.duck);
  if (!tgts.length) tgts = G.et;
  const tg = tgts[Math.floor(Math.random() * tgts.length)];

  const tx = tg.x + (Math.random()-0.5)*10;
  const ty = tg.by - KH * 0.35;
  const dx = tx - me.x, dy = ty - (me.by - 18);
  const d = Math.sqrt(dx*dx + dy*dy);

  G.balls.push({ x: me.x, y: me.by - 18, vx: dx/d*sz.sp, vy: dy/d*sz.sp, r: sz.r, en: false });
  me.cd = 30; me.throwA = 10;
}

function aiEThrow(e) {
  if (G.won || e.duck) return;
  const sk = ['small','medium','large'][Math.floor(Math.random()*3)];
  const sz = SZ[sk];
  let tgts = G.pt.filter(k => !k.duck);
  if (!tgts.length) tgts = G.pt;
  const tg = tgts[Math.floor(Math.random() * tgts.length)];

  const tx = tg.x + (Math.random()-0.5)*22;
  const ty = tg.by - KH * 0.35;
  const dx = tx - e.x, dy = ty - (e.by - 18);
  const d = Math.sqrt(dx*dx + dy*dy);
  const sp = sz.sp * (0.6 + Math.random()*0.35);

  G.balls.push({ x: e.x, y: e.by - 18, vx: dx/d*sp, vy: dy/d*sp, r: sz.r, en: true });
  e.cd = 200 + Math.random()*300; e.throwA = 10;
}

function aiTThrow(t) {
  if (G.won || t.duck || t.isMe) return;
  const sk = ['small','medium'][Math.floor(Math.random()*2)];
  const sz = SZ[sk];
  let tgts = G.et.filter(e => !e.duck);
  if (!tgts.length) tgts = G.et;
  const tg = tgts[Math.floor(Math.random() * tgts.length)];

  const tx = tg.x + (Math.random()-0.5)*28;
  const ty = tg.by - KH * 0.35;
  const dx = tx - t.x, dy = ty - (t.by - 18);
  const d = Math.sqrt(dx*dx + dy*dy);

  G.balls.push({ x: t.x, y: t.by - 18, vx: dx/d*sz.sp*0.7, vy: dy/d*sz.sp*0.7, r: sz.r, en: false });
  t.cd = 220 + Math.random()*300; t.throwA = 10;
}

function spawnVeh() {
  const rc = Z.roadY + Z.roadH / 2;
  const goR = Math.random() < 0.5;
  const isPlow = Math.random() < 0.22;
  const cls = ['#3498db','#e74c3c','#2ecc71','#9b59b6','#1abc9c','#f39c12','#ecf0f1','#34495e'];
  const cl2s = ['#2471a3','#a93226','#1e8449','#6c3483','#148f77','#ca6f1e','#d5dbdb','#2c3e50'];
  const ci = Math.floor(Math.random()*cls.length);

  G.vehs.push({
    x: goR ? -90 : W + 90,
    y: rc + (goR ? -Z.roadH * 0.13 : Z.roadH * 0.13),
    w: isPlow ? 74 : 40 + Math.random() * 14,
    h: isPlow ? 27 : 17 + Math.random() * 5,
    sp: (goR ? 1 : -1) * (isPlow ? (1.5 + Math.random() * 0.8) : (2.5 + Math.random() * 2.5)),
    tp: isPlow ? 'plow' : 'car',
    cl: cls[ci], cl2: cl2s[ci]
  });

  if (isPlow) toast('üöú SNOWPLOW! DUCK!', 1800);
}

function update() {
  if (G.won) return;
  G.fr++;

  const me = G.pt.find(k => k.isMe);
  me.duck = G.pDuck;

  // Cooldowns
  [...G.pt, ...G.et].forEach(k => {
    if (k.cd > 0) k.cd--;
    if (k.throwA > 0) k.throwA--;
    if (k.hitT > 0) k.hitT--;
    if (k.hitT === 0) k.hit = false;
    if (k.duckT > 0) { k.duckT--; if (k.duckT === 0 && !k.isMe) k.duck = false; }
  });

  // Enemy AI - one at a time, relaxed pace, cap total balls in air
  const maxBalls = 6;
  G.et.forEach(e => {
    if (e.cd <= 0 && !e.duck && G.balls.length < maxBalls && Math.random() < 0.004) aiEThrow(e);
    if (!e.duck && Math.random() < 0.002) { e.duck = true; e.duckT = 40 + Math.random() * 50; }
  });

  // Teammate AI - relaxed pace
  G.pt.forEach(t => {
    if (!t.isMe && t.cd <= 0 && !t.duck && G.balls.length < maxBalls && Math.random() < 0.003) aiTThrow(t);
  });

  // Vehicles
  G.vTmr--;
  if (G.vTmr <= 0) { spawnVeh(); G.vTmr = 180 + Math.random() * 320; }

  G.vehs.forEach(v => v.x += v.sp);

  // Snowplow danger
  G.vehs.forEach(v => {
    if (v.tp === 'plow') {
      // AI auto-duck near plow
      [...G.et, ...G.pt].forEach(k => {
        if (!k.isMe && Math.abs(k.x - v.x) < 110 && !k.duck) {
          k.duck = true; k.duckT = 50;
        }
      });
      // Player danger: if plow blade passes player and not ducking
      if (!me.duck && !me.hit) {
        const bladeX = v.sp > 0 ? v.x + v.w / 2 + 15 : v.x - v.w / 2 - 15;
        if (Math.abs(me.x - bladeX) < 16) {
          me.hit = true; me.hitT = 40;
          G.es++;
          burst(me.x, me.by - 10, 14, '#b8d8f0');
          toast('üí• Snowplow spray! Duck next time!', 1600);
          updHUD(); chkWin();
        }
      }
    }
  });

  G.vehs = G.vehs.filter(v => v.x > -120 && v.x < W + 120);

  // Snowballs
  G.balls = G.balls.filter(b => {
    b.x += b.vx; b.y += b.vy;
    if (b.y < -30 || b.y > H + 30 || b.x < -30 || b.x > W + 30) return false;

    // Hit a vehicle?
    for (const v of G.vehs) {
      if (Math.abs(b.x - v.x) < v.w/2 + b.r && Math.abs(b.y - v.y) < v.h/2 + b.r) {
        burst(b.x, b.y, 8, '#e0eef6'); return false;
      }
    }

    if (b.en) {
      // Check player team
      for (const k of G.pt) {
        if (k.hit) continue;
        const hy = k.duck ? k.by + KH * 0.52 : k.by;
        const hh = k.duck ? KH * 0.18 : KH * 0.65;
        if (Math.abs(b.x - k.x) < KW/2 + b.r + 3 && b.y > hy - hh/2 && b.y < hy + hh/2) {
          if (k.duck) continue;
          k.hit = true; k.hitT = 38;
          G.es++;
          burst(b.x, b.y, 14, '#fff');
          if (k.isMe) toast('üí• You got hit!', 900);
          updHUD(); chkWin();
          return false;
        }
      }
    } else {
      // Check enemy team
      for (const k of G.et) {
        if (k.hit) continue;
        const hy = k.duck ? k.by + KH * 0.52 : k.by;
        const hh = k.duck ? KH * 0.18 : KH * 0.65;
        if (Math.abs(b.x - k.x) < KW/2 + b.r + 3 && b.y > hy - hh/2 && b.y < hy + hh/2) {
          if (k.duck) continue;
          k.hit = true; k.hitT = 38;
          G.ps++;
          burst(b.x, b.y, 14, '#fff');
          toast('üéØ Direct hit!', 700);
          updHUD(); chkWin();
          return false;
        }
      }
    }
    return true;
  });
}

function updHUD() {
  document.getElementById('sB').textContent = G.ps;
  document.getElementById('sR').textContent = G.es;
}

function chkWin() {
  if (G.ps >= GOAL) { G.won = true; setTimeout(() => showWin(true), 550); }
  else if (G.es >= GOAL) { G.won = true; setTimeout(() => showWin(false), 550); }
}

function showWin(w) {
  document.getElementById('wE').textContent = w ? 'üèÜ' : 'üò¢';
  document.getElementById('wT').textContent = w ? 'You Win!' : 'You Lost!';
  document.getElementById('wS').textContent = w ? 'Your team crushed it! ‚ùÑÔ∏è' : 'Better luck next time!';
  document.getElementById('wF').textContent = \`\${G.ps} ‚Äî \${G.es}\`;
  document.getElementById('wov').classList.add('v');
}

// ==================== RENDER ====================
function render() {
  cx.clearRect(0, 0, W, H);

  drawScene();

  // Enemies (drawn first, then wall covers their lower body)
  G.et.forEach(k => drawKid(k, false));
  drawBank(Z.tBankY, Z.bankH, '#e2edf6', '#d6e4f0', false);

  // Vehicles on road
  G.vehs.forEach(v => drawVeh(v));

  // Player team (drawn first, then wall covers their lower body)
  G.pt.forEach(k => drawKid(k, true));
  drawBank(Z.bBankY, Z.bankH, '#dee9f3', '#d0e0ee', true);

  // Player indicator ON TOP of the wall so it's always visible
  const me = G.pt.find(k => k.isMe);
  if (me) drawPlayerIndicator(me);

  // Pile, balls, particles, snow
  drawPile();
  G.balls.forEach(b => drawBall(b));
  drawParts();
  drawFlakes();
}

function loop() {
  if (!running) return;
  update(); render();
  loopId = requestAnimationFrame(loop);
}

// ==================== FLOW ====================
function startGame() {
  document.getElementById('selScreen').classList.add('hidden');
  document.getElementById('hud').classList.add('on');
  document.getElementById('qBtn').classList.add('on');
  document.getElementById('szp').classList.add('on');
  cv.style.display = 'block';
  if (TOUCH) document.getElementById('mc').classList.add('on');

  const sp = document.getElementById('szp');
  sp.style.bottom = TOUCH ? '5rem' : '0.7rem';
  sp.style.left = '50%'; sp.style.transform = 'translateX(-50%)';

  initGame(); updHUD();
  running = true; loop();
}

function replay() {
  document.getElementById('wov').classList.remove('v');
  initGame(); updHUD();
  G.bsz = document.querySelector('.szb.on')?.dataset.s || 'small';
}

function quit() {
  parent.postMessage("back","*");
  running = false; cancelAnimationFrame(loopId);
  cv.style.display = 'none';
  document.getElementById('hud').classList.remove('on');
  document.getElementById('qBtn').classList.remove('on');
  document.getElementById('szp').classList.remove('on');
  document.getElementById('mc').classList.remove('on');
  document.getElementById('wov').classList.remove('v');
  document.getElementById('selScreen').classList.remove('hidden');
}

// ==================== INPUT ====================
document.addEventListener('keydown', e => {
  if (!running || !G || G.won) return;
  if (e.key === 'ArrowDown') { G.pDuck = true; e.preventDefault(); }
  if (e.key === ' ' || e.key === 'ArrowUp') { playerThrow(); e.preventDefault(); }
  if (e.key === '1') pickSz('small', document.querySelector('.szb[data-s="small"]'));
  if (e.key === '2') pickSz('medium', document.querySelector('.szb[data-s="medium"]'));
  if (e.key === '3') pickSz('large', document.querySelector('.szb[data-s="large"]'));
});
document.addEventListener('keyup', e => {
  if (e.key === 'ArrowDown' && G) G.pDuck = false;
});

function bind(id, dn, up) {
  const el = document.getElementById(id);
  if (!el) return;
  el.addEventListener('touchstart', e => { e.preventDefault(); dn(); }, { passive: false });
  el.addEventListener('touchend', e => { e.preventDefault(); up(); }, { passive: false });
  el.addEventListener('touchcancel', up);
  el.addEventListener('mousedown', e => { e.preventDefault(); dn(); });
  el.addEventListener('mouseup', up);
  el.addEventListener('mouseleave', up);
}

bind('bDuck',
  () => { if (G) { G.pDuck = true; document.getElementById('bDuck').classList.add('p'); }},
  () => { if (G) { G.pDuck = false; document.getElementById('bDuck').classList.remove('p'); }}
);
bind('bThrow', () => { if (G) playerThrow(); }, () => {});

cv.addEventListener('click', e => {
  if (!running || !G || G.won) return;
  if (e.clientY < H * 0.55) playerThrow();
});

document.addEventListener('touchmove', e => { if (running) e.preventDefault(); }, { passive: false });

// ==================== MENU SNOWFLAKES ====================
const sdc = document.getElementById('sdeco');
for (let i = 0; i < 30; i++) {
  const s = document.createElement('div');
  s.className = 'sf';
  s.textContent = ['‚ùÑ','‚ùÖ','‚ùÜ','‚Ä¢'][Math.floor(Math.random()*4)];
  s.style.left = Math.random()*100+'%';
  s.style.fontSize = (0.5+Math.random()*0.85)+'rem';
  s.style.setProperty('--o',(0.12+Math.random()*0.3).toFixed(2));
  s.style.setProperty('--d',(Math.random()-0.5)*50+'px');
  s.style.animationDuration = (5+Math.random()*7)+'s';
  s.style.animationDelay = Math.random()*7+'s';
  sdc.appendChild(s);
}
</script>
</body>
</html>
`;

// ===== GAME LAUNCHER =====
let currentBlob = null;

function launchGame(id) {
  const html = GAMES[id];
  if (!html) return;

  // Clean up previous blob
  if (currentBlob) URL.revokeObjectURL(currentBlob);

  const blob = new Blob([html], { type: 'text/html' });
  currentBlob = URL.createObjectURL(blob);

  const frame = document.getElementById('gameFrame');
  frame.src = currentBlob;
  frame.classList.add('active');
  document.getElementById('menu').classList.add('hidden');
}

function showMenu() {
  const frame = document.getElementById('gameFrame');
  frame.classList.remove('active');
  frame.src = 'about:blank';
  document.getElementById('menu').classList.remove('hidden');
  if (currentBlob) { URL.revokeObjectURL(currentBlob); currentBlob = null; }
}

// Listen for back-to-menu messages from games
window.addEventListener('message', function(e) {
  if (e.data === 'back') showMenu();
});
</script>
</body>
</html>